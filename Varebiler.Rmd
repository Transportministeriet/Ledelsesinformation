---
title: "Varebiler"
output:
  html_document:
    css: styles.css
date: 'Opdateret `r format(Sys.Date(), "%d. %B %Y")`'
---
```{r, echo=FALSE, warning=FALSE, message=FALSE}
extrafont::loadfonts()
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message = FALSE )

library(tidyverse)
library(readxl)
library(sf)
library(TRMvisual)
library(extrafont)
library(statbank)
library(highcharter)
library(knitr)
library(extrafont)
library(ggpp)
library(officer)
library(lubridate)
library(plotly)
library(scales)
library(downloadthis)
library(htmltools)


lang <- getOption("highcharter.lang")
lang$decimalPoint <- ","
lang$thousandsSep <- "."
lang$numericSymbols <- highcharter::JS("null") # optional: remove the SI prefixes
options(highcharter.lang = lang)


options(scipen = 100, digits = 2, OutDec = ",")
Sys.setenv(Lang = "da")

knit_hooks$set(inline = function(x) {
  if(is.numeric(x)){
    return(prettyNum(x, big.mark=".", digits = 2))
  } else{
    return(x)
  }
})

if(month(Sys.Date())==1){
  stjerne <- ""
  stjerne_tekst <- ""
} else{
  stjerne <- "*"
  stjerne_tekst <- "*År til dato"
}


sti_kf <- "S:/TRM Databank/003 Klimafremskrivning"


#Data til bestand
data_bil <- tbl_dst("BIL54", "da") |> 
  filter(BILTYPE %in% c("4000102000"), OMRÅDE == "000", 
         BRUG %in% c("1000")) |> 
  use_labels() |> 
  collect() |> 
  select(-c("OMRÅDE", "BRUG")) %>% 
  mutate(DRIV = ifelse(str_detect(DRIV, "hybrid"), "Plug-in-hybrid", DRIV),
         DRIV = ifelse(DRIV %in% c("Drivmidler i alt", "Benzin", "Diesel", "El", "Plug-in-hybrid"),
                       DRIV,
                       "Øvrige drivmidler")) %>% 
  summarise(INDHOLD=sum(INDHOLD),
            .by = c("DRIV","TID"))

data_husholdning <- tbl_dst("BIL54", "da") |> 
  filter(BILTYPE %in% c("4000102000"), OMRÅDE == "000", 
         BRUG %in% c("1100")) |> 
  use_labels() |> 
  collect() |> 
  select(-c("OMRÅDE", "BRUG")) %>% 
  mutate(DRIV = ifelse(str_detect(DRIV, "hybrid"), "Plug-in-hybrid", DRIV),
         DRIV = ifelse(DRIV %in% c("Drivmidler i alt", "Benzin", "Diesel", "El", "Plug-in-hybrid"),
                       DRIV,
                       "Øvrige drivmidler")) %>% 
  summarise(INDHOLD=sum(INDHOLD),
            .by = c("DRIV","TID"))

data_erhverv <- tbl_dst("BIL54", "da") |> 
  filter(BILTYPE %in% c("4000102000"), OMRÅDE == "000", 
         BRUG %in% c("1200")) |> 
  use_labels() |> 
  collect() |> 
  select(-c("OMRÅDE", "BRUG")) %>% 
  mutate(DRIV = ifelse(str_detect(DRIV, "hybrid"), "Plug-in-hybrid", DRIV),
         DRIV = ifelse(DRIV %in% c("Drivmidler i alt", "Benzin", "Diesel", "El", "Plug-in-hybrid"),
                       DRIV,
                       "Øvrige drivmidler")) %>% 
  summarise(INDHOLD=sum(INDHOLD),
            .by = c("DRIV","TID"))


data_bil_1 <- data_bil |>
  mutate(
    AAR = round(as.numeric(str_sub(TID, end = 4)) + (as.numeric(str_sub(TID, start = -2)) - 1) / 12, 3),
    DATE = as.Date(str_c(str_sub(TID, end = 4), "-", str_sub(TID, start = -2), "-01")),
    DATE_1 = DATE %m+% months(1),
    UDV_BIL = INDHOLD - lag(INDHOLD),
    .by =  "DRIV"
  )

data_bil_1_ny <- data_bil_1 %>%
  mutate(AAR = as.numeric(substr(as.character(AAR), 1, 4))) %>%
  filter(DRIV != "Drivmidler i alt") %>%  # Remove total category
  group_by(AAR, DRIV) %>%
  filter(!is.na(INDHOLD)) %>%  # Remove NAs before applying last()
  summarise(ANTAL = last(INDHOLD), .groups = "drop")  # Get last INDHOLD per year

data_bil_hus_1 <- data_husholdning |>
  mutate(
    AAR = round(as.numeric(str_sub(TID, end = 4)) + (as.numeric(str_sub(TID, start = -2)) - 1) / 12, 3),
    DATE = as.Date(str_c(str_sub(TID, end = 4), "-", str_sub(TID, start = -2), "-01")),
    DATE_1 = DATE %m+% months(1),
    UDV_BIL = INDHOLD - lag(INDHOLD),
    .by =  "DRIV"
  )

data_bil_hus_1_ny <- data_bil_hus_1 %>%
  mutate(AAR = as.numeric(substr(as.character(AAR), 1, 4))) %>%
  filter(DRIV != "Drivmidler i alt") %>%  # Remove total category
  group_by(AAR, DRIV) %>%
  filter(!is.na(INDHOLD)) %>%  # Remove NAs before applying last()
  summarise(ANTAL = last(INDHOLD), .groups = "drop")  # Get last INDHOLD per year

data_bil_hus_1_ny <- data_bil_hus_1_ny %>%
  group_by(AAR) %>%
  mutate(A_BESTAND = (ANTAL / sum(ANTAL)) * 100,
         DRIV = factor(DRIV, levels = c("Benzin", "Diesel", "Plug-in-hybrid" ,"El"))) %>%
  ungroup() %>% 
  filter(!AAR %in% c(2018, 2019), 
         DRIV != "Øvrige drivmidler")

data_bil_erhverv_1 <- data_erhverv |>
  mutate(
    AAR = round(as.numeric(str_sub(TID, end = 4)) + (as.numeric(str_sub(TID, start = -2)) - 1) / 12, 3),
    DATE = as.Date(str_c(str_sub(TID, end = 4), "-", str_sub(TID, start = -2), "-01")),
    DATE_1 = DATE %m+% months(1),
    UDV_BIL = INDHOLD - lag(INDHOLD),
    .by =  "DRIV"
  )

data_bil_erhverv_1_ny <- data_bil_erhverv_1 %>%
  mutate(AAR = as.numeric(substr(as.character(AAR), 1, 4))) %>%
  filter(DRIV != "Drivmidler i alt") %>%  # Remove total category
  group_by(AAR, DRIV) %>%
  filter(!is.na(INDHOLD)) %>%  # Remove NAs before applying last()
  summarise(ANTAL = last(INDHOLD), .groups = "drop")  # Get last INDHOLD per year

data_bil_erhverv_1_ny <- data_bil_erhverv_1_ny %>%
  group_by(AAR) %>%
  mutate(A_BESTAND = (ANTAL / sum(ANTAL)) * 100,
         DRIV = factor(DRIV, levels = c("Benzin", "Diesel", "Plug-in-hybrid" ,"El"))) %>%
  ungroup() %>% 
  filter(!AAR %in% c(2018, 2019), 
         DRIV != "Øvrige drivmidler")

#Data til nysalg
data_nysalg <- tbl_dst("BIL53", "da") %>% 
  filter(BILTYPE %in% c("4000102000"), OMRÅDE == "000", BRUG %in% "1000") %>% 
  use_labels() %>% 
  collect() %>% 
  select(-c("OMRÅDE", "BRUG")) %>% 
  mutate(DRIV = ifelse(str_detect(DRIV, "hybrid"), "Plug-in-hybrid", DRIV),
         DRIV = ifelse(DRIV %in% c("Drivmidler i alt", "Benzin", "Diesel", "El", "Plug-in-hybrid"),
                       DRIV,
                       "Øvrige drivmidler")) %>%
  filter(DRIV != "Drivmidler i alt") %>% 
  summarise(INDHOLD = sum(INDHOLD), .by = c("DRIV", "TID"))

data_nysalg_husholdning <- tbl_dst("BIL53", "da") %>% 
  filter(BILTYPE %in% c("4000102000"), OMRÅDE == "000", BRUG %in% "1100") %>% 
  use_labels() %>% 
  collect() %>% 
  select(-c("OMRÅDE", "BRUG")) %>% 
  mutate(DRIV = ifelse(str_detect(DRIV, "hybrid"), "Plug-in-hybrid", DRIV),
         DRIV = ifelse(DRIV %in% c("Drivmidler i alt", "Benzin", "Diesel", "El", "Plug-in-hybrid"),
                       DRIV,
                       "Øvrige drivmidler")) %>%
  filter(DRIV != "Drivmidler i alt") %>% 
  summarise(INDHOLD = sum(INDHOLD), .by = c("DRIV", "TID"))

data_nysalg_erhverv <- tbl_dst("BIL53", "da") %>% 
  filter(BILTYPE %in% c("4000102000"), OMRÅDE == "000", BRUG %in% "1200") %>% 
  use_labels() %>% 
  collect() %>% 
  select(-c("OMRÅDE", "BRUG")) %>% 
  mutate(DRIV = ifelse(str_detect(DRIV, "hybrid"), "Plug-in-hybrid", DRIV),
         DRIV = ifelse(DRIV %in% c("Drivmidler i alt", "Benzin", "Diesel", "El", "Plug-in-hybrid"),
                       DRIV,
                       "Øvrige drivmidler")) %>%
  filter(DRIV != "Drivmidler i alt") %>% 
  summarise(INDHOLD = sum(INDHOLD), .by = c("DRIV", "TID"))


Nummer_sidste_md <- data_nysalg |> 
  slice_tail(n=1) |> 
  pull(TID) |> 
  (\(y) ifelse(str_sub(y, start = -2, end = -2) == "0", str_sub(y, start = -1), str_sub(y, start = -2)))()


nyeste_aar <- data_nysalg |> 
  slice_tail(n=1) |> 
  pull(TID) |> 
  (\(y) str_c(str_sub(y, end = 4)))()


max_aar <- as.numeric(nyeste_aar)
# legend_sort <- c("El", "Plug-in-hybrid", "Diesel","Benzin","Øvrige drivmidler", "Drivmidler i alt")
legend_sort <- c("Øvrige drivmidler", "Benzin", "Diesel", "Plug-in-hybrid", "El" , "Drivmidler i alt")

data_nysalg_1 <- data_nysalg |> 
  mutate(AAR = str_sub(TID, end = 4)) |> 
  (\(y) bind_rows(group_by(y, AAR, DRIV) |>
                    summarise(INDHOLD = sum(INDHOLD),
                              .groups = "drop_last") |> 
                    mutate(A_INDHOLD = round(INDHOLD/sum(INDHOLD, na.rm = T)*100 ,1)) |> 
                    ungroup(), 
                  filter(y, TID==max(TID)) |> 
                    summarise(AAR = str_c(str_sub(TID, end = 4), " (",
                                          format(ISOdate(2000, str_sub(TID, start = -2), 1), "%B"),")"),
                              INDHOLD = sum(INDHOLD),
                              .by = "DRIV") |> 
                    mutate(A_INDHOLD = round(INDHOLD/sum(INDHOLD, na.rm = T)*100, 1)) |> 
                    ungroup()))() |> 
  mutate(DRIV = factor(DRIV, levels = legend_sort))

data_nysalg_hus_1 <- data_nysalg_husholdning |> 
  mutate(AAR = str_sub(TID, end = 4)) |> 
  (\(y) bind_rows(group_by(y, AAR, DRIV) |>
                    summarise(INDHOLD = sum(INDHOLD),
                              .groups = "drop_last") |> 
                    mutate(A_INDHOLD = round(INDHOLD/sum(INDHOLD, na.rm = T)*100 ,1)) |> 
                    ungroup(), 
                  filter(y, TID==max(TID)) |> 
                    summarise(AAR = str_c(str_sub(TID, end = 4), " (",
                                          format(ISOdate(2000, str_sub(TID, start = -2), 1), "%B"),")"),
                              INDHOLD = sum(INDHOLD),
                              .by = "DRIV") |> 
                    mutate(A_INDHOLD = round(INDHOLD/sum(INDHOLD, na.rm = T)*100, 1)) |> 
                    ungroup()))() |> 
  mutate(DRIV = factor(DRIV, levels = legend_sort))

data_nysalg_erhverv_1 <- data_nysalg_erhverv |> 
  mutate(AAR = str_sub(TID, end = 4)) |> 
  (\(y) bind_rows(group_by(y, AAR, DRIV) |>
                    summarise(INDHOLD = sum(INDHOLD),
                              .groups = "drop_last") |> 
                    mutate(A_INDHOLD = round(INDHOLD/sum(INDHOLD, na.rm = T)*100 ,1)) |> 
                    ungroup(), 
                  filter(y, TID==max(TID)) |> 
                    summarise(AAR = str_c(str_sub(TID, end = 4), " (",
                                          format(ISOdate(2000, str_sub(TID, start = -2), 1), "%B"),")"),
                              INDHOLD = sum(INDHOLD),
                              .by = "DRIV") |> 
                    mutate(A_INDHOLD = round(INDHOLD/sum(INDHOLD, na.rm = T)*100, 1)) |> 
                    ungroup()))() |> 
  mutate(DRIV = factor(DRIV, levels = legend_sort))


data_nysalg_3<- data_nysalg |> 
  mutate(DRIV = ifelse(str_detect(DRIV, "hybrid"), "Plug-in-hybrid", DRIV),
         AAR = str_sub(TID)) |> 
  group_by(AAR, DRIV) |> 
  summarise(INDHOLD = sum(INDHOLD),
            .groups = "drop_last") |> 
  mutate(A_INDHOLD = round(INDHOLD/sum(INDHOLD)*100 ,1)) |> 
  ungroup()|> 
  mutate(DRIV = factor(DRIV, levels =legend_sort))

data_nysalg_2 <- data_nysalg |> 
  mutate(DRIV = ifelse(str_detect(DRIV, "hybrid"), "Plug-in-hybrid", DRIV),
         AAR = str_sub(TID, end = 4)) |> 
  filter(DRIV != "Drivmidler i alt") %>% 
  group_by(AAR, DRIV) |> 
  summarise(INDHOLD = sum(INDHOLD, na.rm = T),
            .groups = "drop_last") |> 
  mutate(A_INDHOLD = round(INDHOLD/sum(INDHOLD)*100 ,1)) |> 
  ungroup() |> 
  mutate(DRIV = factor(DRIV, levels =legend_sort),
         year = as.numeric(AAR))


data_nysalg_3 <- data_nysalg_3 %>%
  mutate(year = year(ymd(paste0(AAR, "01"))),
         month = month(ymd(paste0(AAR, "01")))) %>%
  mutate(formatted_date = paste(format(ISOdate(2000, month, 1), "%B"), year)) # Use the Danish month names and the year to create the desired format

Måned_max_EL_andel <- data_nysalg_3 %>%
  filter(DRIV=="El") %>%
  slice(which.max(A_INDHOLD)) %>%
  pull(formatted_date)


Værdi_max_EL_andel <- data_nysalg_3 %>%
  filter(DRIV=="El") %>%
  slice(which.max(A_INDHOLD)) %>%
  pull(A_INDHOLD)


```

```{r}
totalsalg <- data_nysalg_1 %>%
  filter(AAR == nyeste_aar) %>%
  summarize(sum_indhold = sum(INDHOLD))

eltotalsalg <- data_nysalg_1 %>%
  filter(AAR == nyeste_aar, DRIV == "El") %>%
  summarize(sum_indhold = sum(INDHOLD))

fostotalsalg <- data_nysalg_1 %>%
  filter(AAR == nyeste_aar, DRIV %in% c("Benzin", "Diesel")) %>%
  summarize(sum_indhold = sum(INDHOLD))

totalsalg_hus <- data_nysalg_hus_1 %>%
  filter(AAR == nyeste_aar) %>%
  summarize(sum_indhold = sum(INDHOLD))

eltotalsalg_hus <- data_nysalg_hus_1 %>%
  filter(AAR == nyeste_aar, DRIV == "El") %>%
  summarize(sum_indhold = sum(INDHOLD))

fostotalsalg_hus <- data_nysalg_hus_1 %>%
  filter(AAR == nyeste_aar, DRIV %in% c("Benzin", "Diesel")) %>%
  summarize(sum_indhold = sum(INDHOLD))

totalsalg_erhverv <- data_nysalg_erhverv_1 %>%
  filter(AAR == nyeste_aar) %>%
  summarize(sum_indhold = sum(INDHOLD))

eltotalsalg_erhverv <- data_nysalg_erhverv_1 %>%
  filter(AAR == nyeste_aar, DRIV == "El") %>%
  summarize(sum_indhold = sum(INDHOLD))

fostotalsalg_erhverv <- data_nysalg_erhverv_1 %>%
  filter(AAR == nyeste_aar, DRIV %in% c("Benzin", "Diesel")) %>%
  summarize(sum_indhold = sum(INDHOLD))

totalbestand <- data_bil_1_ny %>%
  filter(AAR == nyeste_aar) %>%
  summarize(sum_antal = sum(ANTAL))

eltotalbestand <- data_bil_1_ny %>%
  filter(AAR == nyeste_aar, DRIV == "El") %>%
  summarize(sum_antal = sum(ANTAL))

fostotalbestand <- data_bil_1_ny %>%
  filter(AAR == nyeste_aar, DRIV %in% c("Benzin", "Diesel")) %>%
  summarize(sum_antal = sum(ANTAL))

totalbestand_hus <- data_bil_hus_1_ny %>%
  filter(AAR == nyeste_aar) %>%
  summarize(sum_antal = sum(ANTAL))

totalbestand_20_hus <- data_bil_hus_1_ny %>%
  filter(AAR == 2020) %>%
  summarize(sum_antal = sum(ANTAL))

eltotalbestand_hus <- data_bil_hus_1_ny %>%
  filter(AAR == nyeste_aar, DRIV == "El") %>%
  summarize(sum_antal = sum(ANTAL))

fostotalbestand_hus <- data_bil_hus_1_ny %>%
  filter(AAR == nyeste_aar, DRIV %in% c("Benzin", "Diesel")) %>%
  summarize(sum_antal = sum(ANTAL))

totalbestand_erhverv <- data_bil_erhverv_1_ny %>%
  filter(AAR == nyeste_aar) %>%
  summarize(sum_antal = sum(ANTAL))

totalbestand_20_erhverv <- data_bil_erhverv_1_ny %>%
  filter(AAR == 2020) %>%
  summarize(sum_antal = sum(ANTAL))

eltotalbestand_erhverv <- data_bil_erhverv_1_ny %>%
  filter(AAR == nyeste_aar, DRIV == "El") %>%
  summarize(sum_antal = sum(ANTAL))

fostotalbestand_erhverv <- data_bil_erhverv_1_ny %>%
  filter(AAR == nyeste_aar, DRIV %in% c("Benzin", "Diesel")) %>%
  summarize(sum_antal = sum(ANTAL))

fbil_andel_nysalget19 <- data_nysalg_1 %>%
  filter(AAR ==2019) %>%
  filter(DRIV %in% c("Benzin", "Diesel")) %>%  # Filter for values 1 and 2 in 'drit'           # Group by 'AAR'
  summarize(Sum_A_INHOLD = sum(A_INDHOLD)) # Calculate the sum of 'A_INHOLD' for each 'AAR'


fbil_andel_nysalget <- data_nysalg_1 %>%
  filter(AAR ==nyeste_aar) %>%
  filter(DRIV %in% c("Benzin", "Diesel")) %>%  # Filter for values 1 and 2 in 'drit'
  summarize(Sum_A_INHOLD = sum(A_INDHOLD))  # Calculate the sum of 'A_INHOLD' for each 'AAR'

pihb_andel <- data_nysalg_1 %>%
  filter(AAR ==2021) %>%
  filter(DRIV == "Plug-in-hybrid") %>%  # Filter for values 1 and 2 in 'drit'
  summarize(Sum_A_INHOLD = sum(A_INDHOLD))  # Calculate the sum of 'A_INHOLD' for each 'AAR'

ebil_andel_nysalget19 <- data_nysalg_1 %>%
  filter(AAR ==2019) %>%
  filter(DRIV %in% ("El")) %>%  # Filter for values EL in 'drit'           # Group by 'AAR'
  summarize(Sum_A_INHOLD = sum(A_INDHOLD)) # Calculate the sum of 'A_INHOLD' for each 'AAR'


ebil_andel_nysalget <- data_nysalg_1 %>%
  filter(DRIV %in% ("El")) %>%  # Filter for values EL in 'drit'
  summarize(Sum_A_INHOLD = sum(A_INDHOLD),
            .by = "AAR")|>
  pivot_wider(names_from ="AAR", values_from = Sum_A_INHOLD)# Calculate the sum of 'A_INHOLD' for each 'AAR'


ebil_total_nysalget <- data_nysalg_1 %>%
  filter(DRIV %in% ("El")) %>%  # Filter for values EL in 'drit'           # Group by 'AAR'
  summarize(Sum_INHOLD = sum(INDHOLD),
            .by = "AAR") |> 
  pivot_wider(names_from = "AAR", values_from = "Sum_INHOLD")


#Data månedlig tilgang af elbiler til bestanden opgjort i DST og KF23

dat_fig_3 <- tibble("AAR"=round(sort(rep(2022:2026, 12)) + rep((c(1:12)-1)/12, 5), 3)) |> 
  mutate(KF_UDV = round(2467*exp(0.1713*(AAR-2022)),0 )) |> 
  inner_join(data_bil_1 |> 
               filter( DRIV=="El") |> 
               mutate(vaetg_gnst = round((lag(UDV_BIL, 2)+lag(UDV_BIL)+UDV_BIL)/3, 0)) |>  
               select(-c("DRIV","TID","INDHOLD")),
             by="AAR"
  ) |> 
  filter(AAR>=2023)

antal_el_biler_ialt <- dat_fig_3$UDV_BIL |> sum()
antal_el_biler_KF_est <- dat_fig_3$KF_UDV  |> sum()

pct_el_biler_ialt <- (antal_el_biler_ialt/antal_el_biler_KF_est-1)*100


```

```{r}
#Data til Figur ny figur 3 opgørelse af årlig bestand.

ny_figur_3 <- data_bil %>%
  mutate(
    aar = as.numeric(substr(TID, start = 1, stop = nchar(TID) - 3)),
    maaned = as.numeric(substr(TID, start = nchar(TID) - 1, stop = nchar(TID))),
    dansk_måned = str_c("(", format(ISOdate(2000, 1:12, 1), "%B")[maaned], ")"),
    dansk_måned_uden = case_when(
      (maaned == 1) ~ "januar",
      (maaned == 2) ~ "februar",
      (maaned == 3) ~ "marts",
      (maaned == 4) ~ "april",
      (maaned == 5) ~ "maj",
      (maaned == 6) ~ "juni",
      (maaned == 7) ~ "juli",
      (maaned == 8) ~ "august",
      (maaned == 9) ~ "september",
      (maaned == 10) ~ "oktober",
      (maaned == 11) ~ "november",
      (maaned == 12) ~ "december"
    ),
    rigtigt_år = case_when(
      maaned == 12 ~ as.character(aar + 1),
      TRUE ~ paste(as.character(aar), dansk_måned)
    ),
    ultimo = case_when(
      maaned == 12 ~ paste(as.character(aar)),
      TRUE ~ paste(dansk_måned_uden, as.character(aar))
    )
  )


ny_figur_3_1 <- ny_figur_3 %>%
  filter(maaned == max(maaned),
         .by = "aar") %>%
  filter(DRIV !="Drivmidler i alt") %>%
  mutate(DRIV = factor(DRIV, levels = legend_sort))


max_måned <- ny_figur_3 |> 
  slice_tail(n=1) |> 
  pull(dansk_måned_uden)

max_aar <- ny_figur_3 |> 
  slice_tail(n=1) |> 
  pull(aar)

næst_nyeste_aar<-max_aar-1



bestand_2020 <- ny_figur_3_1 %>%
  filter(DRIV != "Drivmidler i alt", aar == 2019) %>%
  summarise(sum_indhold = sum(INDHOLD))

bestand_2023_seneste <- ny_figur_3_1 %>%
  filter(DRIV != "Drivmidler i alt", aar == max_aar,
         dansk_måned_uden == max_måned) %>%
  summarise(sum_indhold = sum(INDHOLD))

andel_elbiler <- ny_figur_3_1 %>%
  filter(DRIV != "Drivmidler i alt", aar == max_aar,
         dansk_måned_uden == max_måned) %>%
  summarise(sum_indhold = sum(INDHOLD))

vækst_siden_2020 <- round((bestand_2023_seneste-bestand_2020)/bestand_2020*100,2)


#Data til figur 4. Status for antallet af el-varebiler

DST_tal <- data_bil_1 |>
  filter(DRIV=="El", 
         DATE_1 %in% c(max(DATE_1), max(DATE_1-1) |> floor_date("years"))) |> 
  mutate(x_axis = ifelse(DATE_1 ==max(DATE_1),
                         str_c(max_måned, " ", nyeste_aar),
                         str_c(round(AAR - 1,0))),
         oprindelse = "DST")

KF_bestand <- read_excel(str_c(sti_kf, "/", "KF24_dataark_Transport.xlsx"),
                         sheet = "Bestand", skip =4) %>% 
  rename("type"=1, drivmiddel = 2) %>% 
  filter(!if_all(.fns =~is.na(.x))) %>% 
  mutate(drivmiddel =coalesce(drivmiddel, "Total")) %>% 
  fill(type) %>% 
  summarise(across(where(is.double), sum),
            .by = c("type","drivmiddel")) %>% 
  pivot_longer(cols = matches("\\d+"), names_to = "aar", values_to = "antal") %>% 
  mutate(antal = round(antal, 0))

KF_tal <- KF_bestand %>% 
  filter(type=="Varebiler", drivmiddel =="BEV") %>% 
  mutate(aar = parse_number(aar),
         x_axis = str_glue("Forventet {aar} (KF24)"),
         oprindelse = "KF") %>% 
  filter(aar %in% c(as.numeric(nyeste_aar), as.numeric(nyeste_aar)+1)) %>% # TODO: Dette skal rettes når der kommer tal fra KF24
  select(INDHOLD=antal, x_axis, oprindelse)

```

```{r}

#Data figur 5. udvikling i bestanden
data_fig_4 <- data_bil_1 |> 
  mutate(DRIV_1 = ifelse(DRIV %in% c("Benzin", "Diesel"), "Fossil varebiler", DRIV) |> 
           factor(levels = c("El", "Plug-in-hybrid", "Fossil varebiler", "Drivmidler i alt")),
         AAR = year(DATE)) |> 
  summarise(INDHOLD = sum(INDHOLD),
            .by = c("DRIV_1", "AAR", "DATE") ) |> 
  mutate(UDV_ANTAL_BIL = INDHOLD-lag(INDHOLD, as.numeric(Nummer_sidste_md)),
         .by = c("DRIV_1")) %>% 
  filter(month(DATE)==Nummer_sidste_md, AAR>2019)


tal <- data_fig_4 |> 
  filter(!is.na(UDV_ANTAL_BIL))

tal_el_2019 <- tal |> filter(DRIV_1=="El", AAR=="2020") |> pull("UDV_ANTAL_BIL")
tal_el_2023 <- tal |> filter(DRIV_1=="El", AAR==nyeste_aar) |> pull("UDV_ANTAL_BIL")
tal_fos_2019 <- tal |> filter(DRIV_1=="Fossil varebiler", AAR=="2020") |> pull("UDV_ANTAL_BIL")
tal_fos_2023 <- tal |> filter(DRIV_1=="Fossil varebiler", AAR==nyeste_aar) |> pull("UDV_ANTAL_BIL")

#SKAL DETTE ÆNDRES TIL "VAREBILER"????


max_year_P_I_H<- data_fig_4 %>%
  filter(DRIV_1 == "Plug-in-hybrid") %>%
  slice(which.max(UDV_ANTAL_BIL)) %>%
  pull(AAR)


```

```{r}

sidste_par_aar <- data_bil_1 |> 
  filter(year(DATE)>(max(year(DATE))-6) & year(DATE)<max(year(DATE)) & DRIV!="Øvrige drivmidler") |> 
  (\(y) bind_rows(y |> filter(year(DATE)==max(year(DATE))) |> 
                    mutate(MD = month(DATE), DRIV, UDV_BIL, TYPE = as.character(max_aar-1),
                           .keep = "none"),
                  y |> 
                    mutate(MD = month(DATE)) |> 
                    summarise(UDV_BIL = round(mean(UDV_BIL), 0), TYPE = str_c(max_aar-5,"-", max_aar-1, " (gennemsnit)"),
                              .by = c("MD", "DRIV"))
  ))()

dette_par_aar <- data_bil_1 |> 
  filter(year(DATE)==max(year(DATE))) |> 
  mutate(MD = month(DATE), DRIV, UDV_BIL, TYPE = as.character(max_aar), .keep = "none")


# danish_month_names_long <- c("Januar", "Februar", "Marts", "April", "Maj", "Juni", "Juli", "August", "September", "Oktober", "November", "December")



Samlet_par_aar <- rbind(sidste_par_aar, dette_par_aar)

Samlet_par_aar <- Samlet_par_aar %>%
  mutate(
    MD = factor(MD, levels = 1:12, labels = format(ISOdate(2000, 1:12, 1), "%B")),
    AAR = as.numeric(TYPE),
    MDAAR = paste(MD, AAR, sep = " ")
  )


max_måned_afvikling_b <- Samlet_par_aar %>%
  filter(DRIV == "Benzin") %>%
  slice(which.min(UDV_BIL)) %>%
  pull(MDAAR)



kombineret_par_aar <- dette_par_aar |> 
  left_join(sidste_par_aar |> 
              rename(UDV_BIL_sid_aar=UDV_BIL) |> 
              filter(TYPE==as.character(max_aar-1)) |> 
              select(-TYPE) %>% 
              distinct(), 
            by = join_by(DRIV, MD)) |>
  mutate(ant_gode_md = (UDV_BIL - UDV_BIL_sid_aar)<0) |> 
  summarise(ant_gode_md = sum(ant_gode_md),
            .by ="DRIV") %>% 
  left_join( tibble(ant_gode_md = c(0:12),
                    bogstav_tal = c("nul", "en", "to", "tre", "fire", "fem", "seks", "syv", "otte", "ni", "ti", "elleve", "tolv")))

md_d_afvikles_hurtigere <- kombineret_par_aar[kombineret_par_aar$DRIV=="Diesel", "bogstav_tal"]

md_b_afvikles_hurtigere <- kombineret_par_aar[kombineret_par_aar$DRIV=="Benzin", "bogstav_tal"]

md_e_afvikles_hurtigere <- kombineret_par_aar[kombineret_par_aar$DRIV=="El", "bogstav_tal"]

md_e_udvikles_hurtigere <- 12 - kombineret_par_aar %>%
  filter(DRIV == "El") %>%
  pull(ant_gode_md)

bogstav_tal <- tibble(
  number = c(0:12),
  text = c("nul", "en", "to", "tre", "fire", "fem", "seks", "syv", "otte", "ni", "ti", "elleve", "tolv")
)

md_e_udvikles_hurtigere <- bogstav_tal %>%
  filter(number == md_e_udvikles_hurtigere) %>%
  pull(text)


```

```{r}

figur_1 <- data_nysalg_2 %>% 
  select(år=AAR, 
         drivmiddel=DRIV,
         antal =INDHOLD)


figur_2 <- data_nysalg_1 %>%
  select(år=AAR, 
         drivmiddel=DRIV,
         andel =INDHOLD)

figur_3 <- ny_figur_3_1 |> 
  filter(DRIV != "Drivmidler i alt" ) |>
  filter(aar != 2018) %>% 
  select(år = rigtigt_år, 
         drivmiddel=DRIV,
         antal =INDHOLD
  ) %>% 
  arrange(år, drivmiddel)

figur_4 <- bind_rows(DST_tal, KF_tal) %>% 
  select(titel = x_axis, kilde = oprindelse, antal = INDHOLD)

figur_5 <- data_fig_4 |> 
  filter(!is.na(UDV_ANTAL_BIL)) |> 
  select(år = AAR, 
         drivmiddel=DRIV_1,
         Antal = INDHOLD,
         udvikling =UDV_ANTAL_BIL
  )


figur_6 <- bind_rows(sidste_par_aar, dette_par_aar) |> 
  mutate(år = TYPE, 
         måned = factor(format(ISOdate(2000, MD, 1), "%B"), levels = format(ISOdate(2000, 1:12, 1), "%B")),
         drivmiddel=DRIV,
         udvikling =UDV_BIL,
         .keep = "none"
  ) %>% 
  arrange(år,drivmiddel, måned)



```

Dette er Transportministeriets interne statusnotat for nyregistreringer og bestanden af varebiler. Det viser bl.a. udviklingen i antallet af varebiler fordelt på drivmiddeltyper. Notatet opdateres månedligt.

Data fra rapporten kan hentes her:
```{r}
list("Figur 1" = figur_1, "Figur 2" = figur_2, "Figur 3" = figur_3, 
     "Figur 4" = figur_4, "Figur 5" = figur_5, "Figur 6" = figur_6) %>%
  download_this(
    output_name = "Data til rapport om status på elbilsudvikling",
    output_extension = ".xlsx",
    button_label = "Download datasæt",
    button_type = "info",
    has_icon = TRUE,
    icon = "fa fa-save"
  )
```


### Status på udviklingen af bestanden
I perioden fra 2021 til 2023 faldt antallet af nyregistreringer, mens det er steget igen i 2024. I `r nyeste_aar` er der hidtil `r pull(totalsalg)` nyregistrerede varebiler, hvoraf `r pull(ebil_total_nysalget, nyeste_aar)` var elvarebiler. Til sammenligning  var der i `r as.character(max_aar-1)` registreret `r pull(ebil_total_nysalget, as.character(max_aar-1))` nye elvarebiler. 

```{r}
#FIGUR 1. Udvikling i nyregistreringer af varebiler fordelt på drivmiddel

farver <- c("graa", "groen",  "orange", "blaa", "gul") %>% factor(., levels = .) %>% sort(decreasing = T)


format_chart <- function(x, titel, note = NULL) {
  library(stringr)
  library(highcharter)
  
  x %>%
    hc_chart(spacingTop = 40,
             style = list(fontFamily = 'Georgia')) %>%
    hc_title(text = titel,
             margin = 20,
             align = "left",
             x = 25,
             y = -10,
             style = list(useHTML = TRUE)) %>%
    hc_exporting(
      enabled = TRUE, # always enabled
      filename = paste0("Varebil_", str_extract(titel, "Figur \\d+"))
    ) %>%
    hc_subtitle(point = list(x = 0.5, y = 0.0, xAxis = 0, yAxis = 0), # Position relative to chart
                text = note,
                align = "bottom",
                verticalAlign = "bottom",  # Place at the bottom
                y = 10,  # Adjust position
                style = list(fontSize = "12px", fontStyle = "italic")
    )
}

data_nysalg_2_stjerne <- data_nysalg_2 %>%
  mutate(AAR = ifelse(AAR == nyeste_aar, paste0(AAR, stjerne), AAR))

data_nysalg_2_stjerne |> 
  filter(as.numeric(str_sub(AAR, end = 4))>max(as.numeric(str_sub(AAR, end = 4)))-5,
         DRIV != "Øvrige drivmidler") |> 
  hchart('column', hcaes(x = AAR, y =INDHOLD, group = DRIV ), borderColor = 0) |> 
  hc_plotOptions(column = list(stacking = "normal")) |> 
  hc_colors(c(trm_colors(farver))) |> 
  hc_yAxis(title = list(text = "Antal (tusind)"),
           labels = list(formatter = JS("function() {
      return this.value >= 1000 ? (this.value / 1000).toFixed(0) : this.value;
    }")),
    stackLabels = list(enabled = TRUE, verticalAlign = 'top',
                       crop = FALSE, overflow = 'none')) |> 
  hc_xAxis(title = list(text = NULL)) %>% 
  hc_legend(reversed =TRUE) %>% 
  hc_tooltip(shared = TRUE) %>% 
  trm_hc_format("<b>Figur 1.</b> Udvikling i nyregistreringer af varebiler fordelt på drivmiddel",
                note = str_glue("Kilde: Danmarks Statistik<br>{stjerne_tekst}"))



```

Elvarebilers andel af det samlede antal nyregistreringer har været stigende siden 2020. I 2020 udgjorde elvarebiler `r pull(ebil_andel_nysalget, "2020") ` pct. af de samlede nyregistreringer.  I `r nyeste_aar` har elvarebiler udgjort `r pull(ebil_andel_nysalget, nyeste_aar) ` pct. af de samlede nyregistreringer, jf. figur 2. I `r format(ISOdate(2000, Nummer_sidste_md, 1), "%B")` udgjorde elvarebiler `r ebil_andel_nysalget[length(ebil_andel_nysalget)] %>% as.numeric()` pct. af nyregistreringerne. Hidtil er den højeste andel nyregistrerede elvarebiler set i `r Måned_max_EL_andel`. 

```{r}
# Figur 2. Drivmidlernes andel af nyregistreringer for varebiler

data_nysalg_1_stjerne <- data_nysalg_1 %>%
  mutate(AAR = ifelse(AAR == nyeste_aar, paste0(AAR, stjerne), AAR))

data_nysalg_1_stjerne |> 
  filter(as.numeric(str_sub(AAR, end = 4))>max(as.numeric(str_sub(AAR, end = 4)))-5,
         DRIV != "Øvrige drivmidler") |> 
  hchart('column', hcaes(x = AAR, y =A_INDHOLD, group = DRIV ), borderColor = 0) |> 
  hc_plotOptions(column = list(stacking = "normal")) |> 
  hc_colors(c(trm_colors(farver))) |> 
  hc_yAxis(title = list(text = "Pct."), max = 100) |> 
  hc_xAxis(title = list(text = NULL)) %>% 
  hc_legend(reversed =TRUE) %>% 
  hc_tooltip(shared = TRUE) %>% 
  trm_hc_format("<b>Figur 2.</b> Drivmidlernes andel af nyregistreringer for varebiler",
                note = str_glue("Kilde: Danmarks Statistik<br>{stjerne_tekst}"))


```

Den 1. januar 2020 var den samlede bestand `r pull(bestand_2020)` varebiler. Fra januar 2020 til `r max_måned` `r nyeste_aar` er bestanden faldet med `r format(vækst_siden_2020, decimal.mark = ",")` pct., så den danske bestand af varebiler ultimo `r max_måned` var `r pull(bestand_2023_seneste)` varebiler. I `r max_måned` `r nyeste_aar` udgjorde elvarebiler `r round(DST_tal$INDHOLD[[2]]/bestand_2023_seneste*100,1)` pct. af den samlede bestand.

```{r}
#Figur 3 opgørelse af årlig bestand

ny_figur_3_1 |> 
  filter(DRIV != "Drivmidler i alt", DRIV != "Øvrige drivmidler" ) |>
  filter(aar != 2018) |>
  hchart('column', hcaes(x = ultimo, y = INDHOLD, group = DRIV ), borderColor = 0) |> 
  hc_plotOptions(column = list(stacking = "normal")) |> 
  hc_colors(c(trm_colors(farver))) |> 
  hc_yAxis(
    title = list(text = "Antal (tusind)"),
    labels = list(formatter = JS("function() {
      return this.value >= 1000 ? (this.value / 1000).toFixed(0) : this.value;
    }")),
    stackLabels = list(enabled = TRUE, verticalAlign = 'top',
                       crop = FALSE, overflow = 'none')
  ) |> 
  # hc_xAxis(title = list(text = NULL))|>
  #   hc_xAxis(title = list(text = NULL),
  # labels = list(
  #   formatter = JS("
  #     function() {
  #       if (this.isLast) {
  #         return this.value + '*'; // Add a '*' to the last category
  #       }
  #       return this.value;
  #     }
  #   "))
#              ) %>% 
  hc_xAxis(
    title = list(text = NULL)
  ) |> 
  hc_tooltip(shared=TRUE,
             pointFormat = "{series.name}: <b>{point.y:,.0f}</b> varebiler (<b>{point.percentage:.1f}</b> pct.) </b> <br>")  %>% 
  hc_legend(reversed =TRUE) %>% 
  trm_hc_format("<b>Figur 3.</b> Bestand af varebiler",
                note = "Kilde: Danmarks Statistik <br> Note: Bestanden er opgjort ultimo")

rest <- KF_tal$INDHOLD[[2]] - DST_tal$INDHOLD[[2]]

```

Jævnfør Klimastatus og -fremskrivning 2024 vil der ved udgangen af 2025 være `r KF_tal$INDHOLD[[2]]` elvarebiler i Danmark. Bestanden pr. `r str_remove_all(DST_tal$x_axis[[2]], " observeret")` var `r DST_tal$INDHOLD[[2]]` elvarebiler, jf. figur 4. Differencen mellem det nuværende antal elvarebiler og det forventede antal elvarebiler ved udgangen af 2025 er således `r rest`.

```{r}
#Figur 4. Status for antallet af el-varebiler i nyeste aar

bind_rows(DST_tal, KF_tal) |> 
  hchart('column', hcaes(x = x_axis, y = INDHOLD, group=oprindelse), color = trm_colors(c("blaa", "orange")), borderColor = 0) |>
  hc_yAxis(title = list(text = "Antal (tusind)"),
           labels = list(
             formatter = JS("function() {
      return this.value >= 1000 ? (this.value / 1000).toFixed(0) : this.value;
    }"))) |> 
  hc_xAxis(
    title = list(text = NULL),
    
    labels = list(
      align = "center",    # Align labels to center under the bars
      rotation = 0         # Keep labels horizontal (adjust if needed)
    ),
    tickmarkPlacement = "on"  # Ensures bars are centered on ticks
  ) |>
  
  hc_plotOptions(column = list(
    pointWidth = 100,       # Bar width
    groupPadding = 0.52,    # Space between groups of bars
    pointPadding = 0.1    # Space between bars in the same group
  )) %>%
  trm_hc_format(str_glue("<b>Figur 4.</b> Status for antallet af el-varelbiler i {nyeste_aar}"),
                note = "Kilde: Danmarks Statistik & Klimastatus for Fremskrivning 2024
                <br> Note: Bestanden er opgjort ultimo")

```

Alt imens bestanden af elvarebiler er under en positiv udvikling, er bestanden af fossilvarebiler forsat under en negativ udvikling. I de første `r month(max(dat_fig_3$DATE))` måneder af 2020 var der en nettoafgang på `r abs(tal_fos_2019)`, hvor der i de første `r month(max(dat_fig_3$DATE))` måneder af `r nyeste_aar` var en nettoafgang på `r abs(tal_fos_2023)` fossilvarebiler. Det skyldes særligt, at bestanden af dieselvarebiler har været faldende siden august 2020.

Af figuren fremgår det yderligere, at væksten i bestanden af plug-in-bybrid varebiler foreløbig er toppet i `r sprintf("%.0f", max_year_P_I_H)`.

```{r}
# Figur 5. Udvikling i antallet af varebiler fra januar til nyeste måned

data_fig_4 |> 
  filter(!is.na(DRIV_1), !is.na(UDV_ANTAL_BIL)) |> 
  hchart('column', hcaes(x = AAR, y = UDV_ANTAL_BIL, group = DRIV_1 ), borderColor = 0) |> 
  hc_colors(c(trm_colors(c("groen", "orange", "blaa" ,"lyseblaa")))) |> 
  hc_yAxis(title = list(text = "Antal (tusind)"),
           labels = list(
             formatter = JS("function() {
      return this.value ? (this.value / 1000).toFixed(0) : this.value;
    }"))) |> 
  hc_xAxis(title = list(text = NULL)) %>%
  trm_hc_format(str_glue("<b>Figur 5.</b> Udvikling i antallet af varebiler fra ultimo januar til ultimo {format(ISOdate(2000, as.numeric(Nummer_sidste_md), 1), '%B')}" ),
                note = str_glue("Kilde: Danmarks Statistik"))

```

Varebiler kan opdeles efter brug, afhængigt af om de bruges i husholdningen eller i erhvervet. Foreløbigt i `r as.character(nyeste_aar)` udgjorde nyregistreringer i husholdningen `r round(totalsalg_hus/totalsalg * 100,1)` pct. af alle nyregistreringer, svarende til `r totalsalg_hus` varebiler. Her imens stod erhvervet for `r round(totalsalg_erhverv/totalsalg * 100,1)` pct. af nyregistreringerne, svarende til `r format(as.numeric(totalsalg_erhverv), big.mark = ".", decimal.mark = ",", scientific = FALSE)` varebiler.

Opdeles varebiler efter brug, fremgår det, at det primært er varebiler i erhvervet, der omstilles til eldrift. Foreløbigt i `r as.character(nyeste_aar)`  har elvarebiler udgjort `r round(eltotalsalg_hus/totalsalg_hus * 100, 1)` pct. af nyregistreringerne i husholdningen, jf. figur 7.1. I samme periode udgjorde elvarebiler i erhvervet `r round(eltotalsalg_erhverv/totalsalg_erhverv * 100, 1)` pct. af nyregistreringerne, jf. figur 7.2.

```{r}
#Figur 6.1 Husholdningens andel af nyregistreringer for varebiler
data_nysalg_hus_1_stjerne <- data_nysalg_hus_1 %>%
  mutate(AAR = ifelse(AAR == nyeste_aar, paste0(AAR, stjerne), AAR))

fct_sort_hus <- data_nysalg_hus_1_stjerne$AAR %>% unique()

figur6.1 <- data_nysalg_hus_1_stjerne |>
  filter(!AAR %in% c("2018", "2019"), DRIV != "Øvrige drivmidler") |># Exclude rows where AAR CONTATINS "9"
  mutate(AAR = factor(AAR, levels = fct_sort_hus),
         antal = INDHOLD) %>%  # Add ANTAL column for use in the tooltip
  hchart('column', hcaes(x = AAR, y =A_INDHOLD , group = DRIV ), borderColor = 0) |> 
  hc_plotOptions(column = list(stacking = "normal"), style = list(
    fontFamily = "Georgia"
  )) |> 
  hc_colors(as.character(trm_colors(farver[c(1, 2, 3, 4)]))) |>
  hc_yAxis(title = list(text = "Pct."), max = 100) |> 
  hc_xAxis(title = list(text = NULL), categories = fct_sort_hus,
           labels = list(rotation = -30)  # Tilt the labels by -45 degrees (you can adjust the angle)
  ) %>% 
  hc_legend(reversed = TRUE, 
            layout = "horizontal", 
            align = "center", 
            verticalAlign = "bottom",
            itemStyle = list(fontSize = "11px"),
            itemDistance = 2 )%>% 
  hc_chart(marginTop = 90, marginBottom = 180)  %>%
  hc_tooltip(shared = TRUE,             pointFormat = "<b>{series.name}</b>: {point.percentage:.1f} pct. (<b>{point.antal:,.0f}</b> varebiler)<br>") %>%

  trm_hc_format("<b>Figur 6.1</b> Husholdningens andel af nyregistreringer for varebiler",
                note = str_glue("Kilde: Danmarks Statistik <br> {stjerne_tekst}"))


#Figur 6.2 Erhvervets andel af nyregistreringer for varebiler
data_nysalg_erhverv_1_stjerne <- data_nysalg_erhverv_1 %>%
  mutate(AAR = ifelse(AAR == nyeste_aar, paste0(AAR, stjerne), AAR))

fct_sort_erhverv <- data_nysalg_erhverv_1_stjerne$AAR %>% unique()

figur6.2 <- data_nysalg_erhverv_1_stjerne |>
  filter(!AAR %in% c("2018", "2019"), DRIV != "Øvrige drivmidler") |># Exclude rows where AAR CONTATINS "9"
  mutate(AAR = factor(AAR, levels = fct_sort_erhverv),
         antal = INDHOLD) %>%  # Add ANTAL column for use in the tooltip
  hchart('column', hcaes(x = AAR, y =A_INDHOLD , group = DRIV ), borderColor = 0) |> 
  hc_plotOptions(column = list(stacking = "normal"), style = list(
    fontFamily = "Georgia"
  )) |> 
  hc_colors(as.character(trm_colors(farver[c(1, 2, 3, 4)]))) |> 
  hc_yAxis(title = list(text = "Pct."), max = 100) |> 
  hc_xAxis(title = list(text = NULL), categories = fct_sort_erhverv,
           labels = list(rotation = -30)  # Tilt the labels by -45 degrees (you can adjust the angle)
  ) %>% 
  hc_legend(reversed = TRUE, 
            layout = "horizontal", 
            align = "center", 
            verticalAlign = "bottom",
            itemStyle = list(fontSize = "11px"),
            itemDistance = 2 )%>% 
  hc_chart(marginTop = 90, marginBottom = 180)  %>%
  hc_tooltip(shared = TRUE,
             pointFormat = "{series.name}: <b>{point.percentage:.1f}</b> pct. (<b>{point.antal:,.0f}</b> varebiler)<br>") %>%
  trm_hc_format("<b>Figur 6.2</b> Erhvervets andel af nyregistreringer for varebiler",
                note = str_glue("Kilde: Danmarks Statistik <br> {stjerne_tekst}"))

# Create a HTML structure with two columns
html <- tagList(
  div(style = "display: flex; justify-content: space-between;",
      div(style = "width: 48%;", figur6.1),
      div(style = "width: 48%;", figur6.2)))

# Render it in the browser
browsable(html)
```
Bestanden af varebiler i husholdningen og erhvervet udgør henholdsvis `r round(totalbestand_hus/totalbestand * 100, 1)` pct. og `r round(totalbestand_erhverv/totalbestand * 100, 1)` pct. af den samlede bestand af varebiler. Bestanden af varebiler i husholdningerne er faldet med `r abs(round((totalbestand_hus - totalbestand_20_hus)/totalbestand_20_hus * 100, 1))` pct. siden 2020, jf. figur 8.1. Herudover ses det, at elvarebiler næsten ikke udgør en del af varebilbestanden i husholdningerne, hvor fossildrevne varebiler derimod udgør `r round(fostotalbestand_hus/totalbestand_hus * 100, 1)` pct. Bestanden af varebiler i erhvervet er nogenlunde konstant siden 2020, jf. figur 8.2, hvor bestanden er vokset med `r format(as.numeric(totalbestand_erhverv - totalbestand_20_erhverv), big.mark = ".", decimal.mark = ",", scientific = FALSE)` varebiler. Endeligt ses der en vækst i andelen af elvarebiler i erhvervet. Foreløbigt i `r as.character(nyeste_aar)` udgør de `r round(eltotalbestand_erhverv/totalbestand_erhverv * 100, 1)`  pct. af den samlede bestand i erhvervet, mens fossilvarebiler udgør `r round(fostotalbestand_erhverv/totalbestand_erhverv * 100, 1)` pct.
```{r}
#Figur 7.1. Udviklingen i den samlede bestand af varebiler i husholdningen

categories_hus <- unique(data_bil_hus_1_ny$AAR)

figur7.1 <- data_bil_hus_1_ny |> 
  hchart('column', hcaes(x = AAR, y = ANTAL, group = DRIV), borderColor = 0) |> 
  hc_plotOptions(column = list(stacking = "normal")) |> 
  hc_colors(as.character(trm_colors(farver[c(1, 2, 3, 4)]))) |>
  hc_yAxis(
    title = list(text = "Antal"),
    labels = list(formatter = JS("function() {
      return this.value >= 1000 ? (this.value / 1000).toFixed(0) : this.value;
    }")),
    stackLabels = list(enabled = TRUE, verticalAlign = 'top',
                       crop = FALSE, overflow = 'none')
  ) |> 
  hc_xAxis(
    categories = categories_hus,
    title = list(text = NULL),
    labels = list(
      rotation = -30
      # ,
      # formatter = JS("
      #        function() {
      #          var categories_hus = this.axis.categories; // Get the x-axis categories
      #          var secondToLastIndex = categories.length - 2; // Find the second-to-last index
      #          
      #          if (this.pos === secondToLastIndex) {
      #            return this.value + '*'; // Add '*' to the second-to-last category
      #          }
      #          
      #          return this.value;
      #        }
      #      ")
    ) )|>
  hc_tooltip(shared=TRUE,
             pointFormat = "{series.name}: <b>{point.y:,.0f}</b> varebiler (<b>{point.percentage:.1f}</b> pct.) <br>") %>%
  trm_hc_format("<b>Figur 7.1</b> Udviklingen i den samlede bestand af varebiler i husholdningen",
                note = str_glue("Kilde: Danmarks Statistik <br> Note: Bestanden er opgjort ultimo"))%>% 
  hc_legend(reversed = TRUE, 
            layout = "horizontal", 
            align = "center", 
            verticalAlign = "bottom",
            itemStyle = list(fontSize = "11px"),
            itemDistance = 2) %>%  # Add spacing between legend items%>%
  hc_chart(marginBottom = 180)# Reduce font size if necessary %>%  # Adding spacing between items


#Figur 7.2. Udviklingen i den samlede bestand af varebiler i husholdningen

categories_erhverv <- unique(data_bil_erhverv_1_ny$AAR)

figur7.2 <- data_bil_erhverv_1_ny |> 
  hchart('column', hcaes(x = AAR, y = ANTAL, group = DRIV), borderColor = 0) |> 
  hc_plotOptions(column = list(stacking = "normal")) |> 
  hc_colors(as.character(trm_colors(farver[c(1, 2, 3, 4)]))) |> 
  hc_yAxis(
    title = list(text = "Antal"),
    labels = list(formatter = JS("function() {
      return this.value >= 1000 ? (this.value / 1000).toFixed(0) : this.value;
    }")),
    stackLabels = list(enabled = TRUE, verticalAlign = 'top',
                       crop = FALSE, overflow = 'none')
  ) |> 
  hc_xAxis(
    categories = categories_erhverv,
    title = list(text = NULL),
    labels = list(
      rotation = -30
      # ,
      # formatter = JS("
      #        function() {
      #          var categories_erhverv = this.axis.categories; // Get the x-axis categories
      #          var secondToLastIndex = categories.length - 2; // Find the second-to-last index
      #          
      #          if (this.pos === secondToLastIndex) {
      #            return this.value + '*'; // Add '*' to the second-to-last category
      #          }
      #          
      #          return this.value;
      #        }
      #      ")
    ) )|>
  hc_tooltip(shared=TRUE,
             pointFormat = "{series.name}: <b>{point.y:,.0f}</b> varebiler (<b>{point.percentage:.1f}</b> pct.) <br>") %>%
  trm_hc_format("<b>Figur 7.2</b> Udviklingen i den samlede bestand af varebiler i erhvervet",
                note = str_glue("Kilde: Danmarks Statistik <br> Note: Bestanden er opgjort ultimo"))%>% 
  hc_legend(reversed = TRUE, 
            layout = "horizontal", 
            align = "center", 
            verticalAlign = "bottom",
            itemStyle = list(fontSize = "11px"),
            itemDistance = 2) %>%  # Add spacing between legend items%>%
  hc_chart(marginBottom = 180)# Reduce font size if necessary %>%  # Adding spacing between items

# Create a HTML structure with two columns
html2 <- tagList(
  div(style = "display: flex; justify-content: space-between;",
      div(style = "width: 48%;", figur7.1),
      div(style = "width: 48%;", figur7.2)
  )
)

# Render it in the browser
browsable(html2)
```

