---
title: "Busser"
output: html_document
date: 'Opdateret `r format(Sys.Date(), "%d. %B %Y")`'
---


```{r, echo=FALSE, warning=FALSE, message=FALSE}
extrafont::loadfonts()
```


```{css, echo=FALSE}

.main-container {
  max-width: 700px !important;
  margin: auto;
}
body{
  font-family: Georgia;
  font-size: 12pt;
}
.highcharts-background {
    fill: #EDF1F4;

}



```




```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(downloadthis)
library(tidyverse)
library(readxl)
library(sf)
library(TRMvisual)
library(extrafont)
library(statbank)
library(highcharter)
library(knitr)
library(extrafont)
library(ggpp)
library(officer)
library(lubridate)
library(plotly)
library(scales)
library(downloadthis)
library(zoo)



lang <- getOption("highcharter.lang")
lang$decimalPoint <- ","
lang$thousandsSep <- "."
lang$numericSymbols <- highcharter::JS("null") # optional: remove the SI prefixes
options(highcharter.lang = lang)

options(scipen = 1000, digits = 2, decimal.mark = ",", OutDec = ",")
Sys.setenv(Lang = "da")

knit_hooks$set(inline = function(x) {
  if(is.numeric(x)){
  return(prettyNum(x, big.mark=".", digits = 2))
  } else{
    return(x)
  }
})

sti <- "S:/CKA/Databank/006 Bilstatistik/Bus"


til_indlaes <- bilstat_peri <- dir(str_c("S:/CKA/Databank/006 Bilstatistik/Bus")) %>% 
      enframe() %>% 
      mutate(dato = coalesce(parse_date_time2(value, orders = "dmY") %>% as.Date(),
                             map_chr(value, ~strsplit(.x, ', ', fixed = TRUE)[[1]][2]) %>% 
                               map_chr(~strsplit(.x, '- ', fixed = TRUE)[[1]][2]) %>% 
                               parse_date_time2(orders = "dmY") %>% as.Date()
      )) 

seneste_kvt <- til_indlaes %>% 
  filter(str_detect(value, "Nyregistreringer")) %>% 
  filter(dato==max(dato)) %>% 
  (\(y) pull(y, dato) +1)() %>% #Lægger 1 ti da de tilfælde hvor vi er i slutningen af kvartalet vælges det indeværende kvartal
  (\(x) floor_date(x, unit = "quarter")-1)() %>% 
  floor_date(unit = "quarter")


bestand_data <- til_indlaes %>% 
  pull(value) %>% 
  str_subset("Bestand") |>
  (\(y) map_dfr(y, ~read_excel(str_c(sti,"/", .x), skip = 9,
                                .name_repair = str_to_upper) %>% 
     filter(row_number()!=max(row_number()), !is.na(ANVENDELSE)) %>% 
       select(DRIVKRAFT, ANVENDELSE, BESTAND) %>% 
       mutate(DRIVKRAFT = str_extract_all(DRIVKRAFT, "PHEV|El", simplify = T) %>% 
                                na_if("") %>% 
           coalesce(DRIVKRAFT),
         
         DRIV = ifelse(DRIVKRAFT %in% c("Benzin", "Gas", "PHEV",  "Brint", "Ukendt"), "Øvrige drivmidler", DRIVKRAFT) %>% 
           factor(levels = c("Øvrige drivmidler", "Diesel", "El")),
              DATE = parse_number(.x, locale = locale(grouping_mark = "-")),
              DATE = lubridate::dmy(DATE))))() 

bestand_data <- bestand_data %>%
  mutate(DATE = ymd(DATE))

# Håndter NA-værdier og find den nyeste dato
nyeste_dato <- max(bestand_data$DATE, na.rm = TRUE)

# Filtrér dataframen for at få de nyeste observationer
bestand_seneste_data <- bestand_data %>%
  filter(DATE == nyeste_dato)



bestand_data_x <- bestand_seneste_data %>% 
  filter(ANVENDELSE !="Særlig anvendelse") %>% 
  summarise(ANTAL = sum(BESTAND),
            .by = c("DATE", "DRIV")) %>% 
  mutate(AAR = ifelse(month(max(DATE))!=12, 
                      str_c(year(DATE), " (", format(DATE, "%B"), ")"), 
                      as.character(year(DATE)+1)), 
         A_BESTAND = ANTAL/sum(ANTAL)*100,
         .by = "DATE") %>% 
  arrange(AAR) %>% 
  select(AAR, DRIV, ANTAL, A_BESTAND)


bestand_data_1 <- bestand_data %>% 
  filter(ANVENDELSE !="Særlig anvendelse") %>% 
  summarise(ANTAL = sum(BESTAND),
            .by = c("DATE", "DRIV")) %>% 
  mutate(AAR = ifelse(month(max(DATE))!=12, 
                      str_c(year(DATE), " (", format(DATE, "%B"), ")"), 
                      as.character(year(DATE)+1)), 
         A_BESTAND = ANTAL/sum(ANTAL)*100,
         .by = "DATE") %>% 
  filter(!str_detect(AAR, "\\(") | str_detect(AAR, "\\(") & DATE==max(DATE) ) %>% 
  arrange(AAR) %>% 
  select(AAR, DRIV, ANTAL, A_BESTAND)

nyreg_data <- til_indlaes %>% 
  filter(str_detect(value, "Nyregistreringer")) %>% 
  filter(dato==max(dato)) %>% 
  pull(value) %>% 
  {read_excel(str_c(sti, "/", .),
           skip = 10,
           .name_repair = ~str_replace_all(.x, c("\\.| "="_","__"="_", "kvartal_"="")) %>% 
            {ifelse(str_detect(., "\\d+"), str_c("KVT_", .), .)} %>% 
             str_to_upper())} %>%
  filter(!is.na(ANVENDELSE )) %>% 
select(-1, -2, -TOTAL) %>% 
  filter(DRIVKRAFT!="Total") %>% 
  pivot_longer(where(is.numeric)) %>% 
  mutate(DATE = str_remove(name, "KVT_") %>% 
           as.yearqtr(format = "%q_%Y") %>% 
           as.Date(),
         
         DRIVKRAFT = str_extract_all(DRIVKRAFT, "PHEV|El", simplify = T) %>% 
                                na_if("") %>% 
           coalesce(DRIVKRAFT),
         
         # DRIVKRAFT = case_when(str_detect(DRIVKRAFT, "PHEV")~
        #                       str_detect(DRIVKRAFT, "PHEV")
       #                       
         #                       "PHEV", DRIVKRAFT),
         ANTAL = value,
         .keep = "unused") %>% 
  filter(DATE<=seneste_kvt)


  # mutate(DRIV = ifelse(DRIVKRAFT %in% c("El", "Diesel"), DRIVKRAFT, "Øvrige drivmidler"))


nyreg_data_1 <- nyreg_data %>% 
  filter(ANVENDELSE !="Særlig anvendelse") %>% 
  summarise(ANTAL = sum(ANTAL),
            .by = c("DATE", "DRIVKRAFT")) %>% 
  mutate(DRIV = ifelse(DRIVKRAFT %in% c("Benzin", "Gas", "PHEV",  "Brint", "Ukendt"), "Øvrige drivmidler", DRIVKRAFT) %>% 
           factor(levels = c("Øvrige drivmidler", "Diesel", "El")),
         A_NYREG = round(ANTAL/sum(ANTAL)*100, 1),
         .by = "DATE") %>% 
  select(-DRIVKRAFT) %>% 
  arrange(DATE) %>% 
  filter(ANTAL>0) 

nyreg_data_2 <- nyreg_data_1 |> 
  mutate(AAR = str_sub(DATE, end = 4)) |> 
  group_by(AAR, DRIV) |> 
  summarise(ANTAL = sum(ANTAL, na.rm = T),
            .groups = "drop_last") |> 
  mutate(A_NYREG = round(ANTAL/sum(ANTAL)*100 ,1)) |> 
  ungroup()

tapply(bestand_data$BESTAND, bestand_data$ANVENDELSE, sum)


udvalgte_kat <- c("Buskørsel", "Rutekørsel", "Kun godkendt til rutekørsel") %>% 
  factor(., levels = .)


bestand_data_underkat <- bestand_data %>%
  mutate (ANVENDELSE = ifelse(ANVENDELSE %in% c("Buskørsel", "Rutekørsel", "Kun godkendt til rutekørsel"), ANVENDELSE, "Anden anvendelse")
  )


bestand_data_underkat <-  bestand_data_underkat %>% 
  filter (ANVENDELSE %in% udvalgte_kat, month(DATE)==12 | DATE==max(DATE)) %>% 
  summarise(BESTAND = sum(BESTAND), 
                                        .by = c("DATE","ANVENDELSE", "DRIV")) %>% 
  mutate(AAR = ifelse(month(max(DATE))!=12, 
                      str_c(year(DATE), " (", format(DATE, "%B"), ")"), 
                      as.character(year(DATE)+1)), 
         A_BESTAND = BESTAND/sum(BESTAND)*100,
         .by = c("DATE","ANVENDELSE")) %>% 
  select(AAR,ANVENDELSE, DRIV, BESTAND, A_BESTAND) %>% 
  arrange(AAR)

nyreg_data$DATE <- as.Date(nyreg_data$DATE)

#Skaber aar-variabel
nyreg_data$AAR <- as.character(format(nyreg_data$DATE, "%Y")) 


nyreg_data_underkat <- nyreg_data %>%
  # Opret DRIV-kolonnen baseret på DRIVKRAFT
  mutate(DRIV = ifelse(DRIVKRAFT %in% c("El", "Diesel"), DRIVKRAFT, "Øvrige drivmidler")) %>%
  
  # Filtrér for udvalgte kategorier i ANVENDELSE
  filter(ANVENDELSE %in% udvalgte_kat) %>%
  
  # Summering af ANTAL pr. AAR, ANVENDELSE og DRIV
  summarise(ANTAL = sum(ANTAL), .by = c("AAR", "ANVENDELSE", "DRIV"))

# Tilføj seneste AAR baseret på den maksimale DATE
nyreg_data_seneste <- nyreg_data %>%
  filter(DATE == max(DATE)) %>%
  # Sørg for, at DRIV er defineret her også
  mutate(DRIV = ifelse(DRIVKRAFT %in% c("El", "Diesel"), DRIVKRAFT, "Øvrige drivmidler")) %>%
  mutate(AAR = str_c(year(DATE), " (", format(DATE, "%B"), ")")) %>%
  select(AAR, DRIV, ANTAL, ANVENDELSE)

# Bind rows sammen
nyreg_data_underkat <- bind_rows(nyreg_data_underkat, nyreg_data_seneste) %>%
  
  # Beregning af procentandel for nyregistreringer
  mutate(A_NYREG = round(ANTAL / sum(ANTAL) * 100, 1), 
         .by = c("AAR", "ANVENDELSE")) %>%
  
  # Konverter DRIV til en faktor med fastsatte niveauer
 mutate(DRIV = factor(DRIV, levels = c("Øvrige drivmidler", "Diesel", "El")),
         A_NYREG = round(ANTAL / sum(ANTAL) * 100, 1),
         .by = c("AAR", "ANVENDELSE")) %>%
  
  
  # Sorter efter AAR
  arrange(AAR)







```

```{r globale variable til tekst}

nummer_sidste_md <- bestand_data$DATE %>% max() %>% month()
nummer_md_efter <- ifelse(nummer_sidste_md==12,1,nummer_sidste_md+1)

maaneder <- c("januar", "februar", "marts", "april", "maj", "juni", 
               "juli", "august", "september", "oktober", "november", "december")

seneste_md_navn <- maaneder[nummer_sidste_md]

nyeste_aar <- bestand_data$DATE %>% max() %>% year()
nyeste_aar_efter <- ifelse(nummer_sidste_md==12,nyeste_aar+1,nyeste_aar)

totalsalg_seneste <- nyreg_data_1 %>% filter(year(DATE)==max(year(DATE))) %>% pull(ANTAL) %>% sum()
elsalg_seneste <- nyreg_data_1 %>% filter(year(DATE)==max(year(DATE)), DRIV=="El") %>% pull(ANTAL) %>% sum()


totalsalg_naestseneste <- nyreg_data_1 %>% filter(year(DATE)==max(year(DATE))-1) %>% pull(ANTAL) %>% sum()
elsalg_naestseneste <- nyreg_data_1 %>% filter(year(DATE)==max(year(DATE))-1, DRIV=="El") %>% pull(ANTAL) %>% sum()


totalsalg_21 <- nyreg_data_1 %>% filter(year(DATE)==2021) %>% pull(ANTAL) %>% sum()
elsalg_21 <- nyreg_data_1 %>% filter(year(DATE)==2021, DRIV=="El") %>% pull(ANTAL) %>% sum()



seneste_kvt <- nyreg_data_1 %>% 
  filter(DATE==max(DATE)) %>% 
  mutate(KVT = str_c(lubridate::quarter(DATE), ". kvt" ))

bestand_2020 <- bestand_data_1 %>% filter(AAR=="2020") %>% pull(ANTAL) %>% sum()
bestand_seneste <- bestand_data_1 %>% filter(AAR==max(AAR)) %>% pull(ANTAL) %>% sum()
elbestand_seneste <- bestand_data_1 %>% filter(AAR==max(AAR), DRIV=="El") %>% pull(ANTAL) %>% sum()

```



```{r}

figur_1 <- nyreg_data_2 %>% 
  select(år=AAR, 
         drivmiddel=DRIV,
         antal =ANTAL)


figur_2 <- bind_rows(nyreg_data_2, 
          nyreg_data_1 |> 
            filter(DATE==max(DATE)) %>% 
            mutate(AAR = str_c(year(DATE), " (",  lubridate::quarter(DATE), ". Kvt)" ))) %>%
  select(år=AAR,
         drivmiddel=DRIV,
         andel =A_NYREG )

 
figur_3 <- bestand_data_1 |>
  select(år = AAR,
         drivmiddel=DRIV,
         antal =ANTAL , 
         andel = A_BESTAND
  ) 

  figur_4 <- nyreg_data_underkat |> 
  arrange(ANVENDELSE, AAR, desc(DRIV)) |>
  mutate(år = AAR,
         ANVENDELSE = str_replace_all(ANVENDELSE, '_', ' ') %>% 
                          str_to_sentence(),
         drivmiddel=DRIV,
         antal =ANTAL,
         andel = A_NYREG,
         .keep = "none"
  ) 
  
figur_5 <- bestand_data_underkat |> 
  arrange(ANVENDELSE, AAR, desc(DRIV)) |>
    mutate(år = AAR,
         ANVENDELSE = str_replace_all(ANVENDELSE, '_', ' ') %>% 
                          str_to_sentence(),
         drivmiddel=DRIV,
         antal =BESTAND,
         andel = A_BESTAND,
         .keep = "none"
  ) 


```

Dette er Transportministeriets interne statusnotat for nyregistreringer og bestand af busser. Det viser bl.a.   udviklingen i antal busser fordelt på drivmiddeltyper. Notatet opdateres kvartalsvist og er baseret på data fra Bilstatistik.  

Data fra rapporten kan hentes her:
```{r}
list("Figur 1" = figur_1, "Figur 2" = figur_2, "Figur 3" = figur_3) %>%
  download_this(
    output_name = "Data til rapport om status på elbusudviklingen",
    output_extension = ".xlsx",
    button_label = "Download datasæt",
    button_type = "info",
    has_icon = TRUE,
    icon = "fa fa-save"
  )
```


### Status på udviklingen af busbestanden
I løbet af de første `r nummer_sidste_md` måneder af `r as.character(nyeste_aar)` er der nyregistreret `r totalsalg_seneste` busser, hvoraf `r elsalg_seneste` er elbusser. Til sammenligning blev der i hele `r as.character(nyeste_aar-1)` nyregistreret `r elsalg_naestseneste` elbusser. 

```{r}

farver <- c("graa",  "blaa", "orange","groen") %>% factor(., levels = .)

format_chart <- function(x, titel) {
  hc_chart(x, spacingTop = 40,
           style = list(fontFamily = 'Georgia')) %>%
    hc_title(text = titel,
             margin = 20,
             align = "left",
             x = 25,
             y = -10,
             style = list(useHTML = TRUE)) %>%
    hc_exporting(
      enabled = TRUE, # always enabled
      filename = paste0("Bus_", str_extract(titel, "Figur \\d+"))
    )
}
  

nyreg_data_2 |> 
  filter(as.numeric(str_sub(AAR, end = 4))>max(as.numeric(str_sub(AAR, end = 4)))-5) |> 
  hchart('column', hcaes(x = AAR, y =ANTAL, group = DRIV ), borderColor = 0) |> 
  hc_plotOptions(column = list(stacking = "normal")) |> 
  hc_colors(c(trm_colors(farver))) |> 
  hc_yAxis(title = list(text = "Antal"),
           labels = list(formatter = JS("function() {
      return this.value >= 1000 ? (this.value / 1000).toFixed(0) : this.value;
    }")),
    stackLabels = list(enabled = TRUE, verticalAlign = 'top',
                             crop = FALSE, overflow = 'none')) |> 
  hc_xAxis(title = list(text = NULL)) %>% 
  hc_legend(reversed =TRUE) %>% 
  hc_tooltip(shared = TRUE) %>% 
  format_chart("<b>Figur 1.</b> Udvikling i nyregistreringer af busser fordelt på drivmiddel")


```


Elbussers andel af det samlede antal nyregistreringer varierer meget fra år til år, men trenden har været stigende siden 2021. I 2021 udgjorde elbusser `r elsalg_21/totalsalg_21*100` pct. af de samlede nyregistreringer. I `r as.character(nyeste_aar)` har elbusser hidtil udgjort  `r elsalg_seneste/totalsalg_seneste*100` pct. af de samlede nyregistreringer, jf. figur 2. I `r str_c(unique(seneste_kvt$KVT), " ", nyeste_aar)` udgjorde elbusser `r seneste_kvt$A_NYREG[[2]] %>% as.numeric()` pct. af nyregistreringerne.


```{r}

# TODO: forstår ikke helt Camillas kommentarer til tekst

bind_rows(nyreg_data_2, 
          nyreg_data_1 |> 
            filter(DATE==max(DATE)) %>% 
            mutate(AAR = str_c(year(DATE), " (",  lubridate::quarter(DATE), ". Kvt)" ))) %>%
  hchart('column', hcaes(x = AAR, y =A_NYREG , group = DRIV ), borderColor = 0) |> 
  hc_plotOptions(column = list(stacking = "normal")) |> 
  hc_colors(c(trm_colors(farver))) |> 
  hc_yAxis(title = list(text = "Pct."), max = 100) |> 
  hc_xAxis(title = list(text = NULL)) %>% 
  hc_legend(reversed =TRUE) %>% 
  hc_tooltip(shared = TRUE) %>% 
  format_chart ("<b>Figur 2.</b> Drivmidlernes andel af nyregistreringer for busser")

bestand_seneste <- sum(bestand_data_x$ANTAL)

```

Den 1. januar 2020 var den samlede bestand på `r bestand_2020` busser. Fra 2020 til `r as.character(nyeste_aar_efter)` har bestanden været let faldende, så bestanden pr. `r str_c("1. ", format(ISOdate(2000, 1:12, 1), "%B")[as.numeric(nummer_md_efter)], " ", nyeste_aar_efter)` var der `r bestand_seneste` busser. Den `r str_c("1. ", format(ISOdate(2000, 1:12, 1), "%B")[as.numeric(nummer_md_efter)], " ", nyeste_aar_efter)` udgjorde elbusser `r round(bestand_data_x[2, 4], digits = 0)` pct. af den samlede bestand mod 1,2 pct. i 2020. 




```{r}
#Ny figur 3 opgørelse af årlig bestand

bestand_data_2 <- bestand_data_1 %>%
  slice(1:(n() - 3))


bestand_data_2 |> 
  hchart('column', hcaes(x = AAR, y = ANTAL, group = DRIV ), borderColor = 0) |> 
  hc_plotOptions(column = list(stacking = "normal")) |> 
  hc_colors(c(trm_colors(farver))) |> 
  hc_yAxis(
    title = list(text = "Antal"),
    labels = list(
      format = "{value:,.0f}"),
    stackLabels = list(enabled = TRUE, verticalAlign = 'top',
                             crop = FALSE, overflow = 'none')
  ) |> 
  hc_xAxis(title = list(text = NULL))|>
  hc_tooltip(
    pointFormat = "{series.name}: <b>{point.y}<b> busser <br>
    <b>{point.percentage:.1f}<b> pct. af den samlede bestand"
  )  %>% 
  hc_legend(reversed = T) %>% 
  format_chart("<b>Figur 3</b> Udviklingen i den samlede bestand af busser")


nyreg_data_underkat_txt_el <- nyreg_data_underkat %>% filter(AAR == nyeste_aar-1, DRIV == "El") %>% select(ANVENDELSE, A_NYREG) %>% deframe() %>% as.list


EL_KGR<-nyreg_data_underkat_txt_el$`Kun godkendt til rutekørsel`

bestand_data_senestemåned <- tail(bestand_data_underkat, n = 9)

bestand_data_senestemåned_txt_el <- bestand_data_senestemåned %>% filter(DRIV == "El") %>% select(ANVENDELSE, A_BESTAND) %>% deframe() %>% as.list

bestand_data_senestemåned_txt_diesel <- bestand_data_senestemåned %>% filter(DRIV == "Diesel") %>% select(ANVENDELSE, A_BESTAND) %>% deframe() %>% as.list

Diesel_bestand_KGR<-bestand_data_senestemåned_txt_diesel$`Kun godkendt til rutekørsel`

El_bestand_KGR<-bestand_data_senestemåned_txt_el$`Kun godkendt til rutekørsel`


```

Opdeles busserne efter anvendelse ses tydeligt, at der primært nyregistreres elbusser til brug for rutekørsel. Indkøb af busser til rutekørsel styres i højere grad af offentlige udbud, hvilket kan forklare den store forskel. Sidste år udgjorde elbusser `r EL_KGR` pct. af nyregistreringerne for busser kun godkendt til rutekørsel. Til sammenlingning udgjorde elbusser `r nyreg_data_underkat_txt_el$Buskørsel` pct. af nyregistreringerne for busser godkendt til buskørsel.


```{r, results='asis'}
cat("**Figur 4. Andel af nyregistreringer fordelt på anvendelse og drivmiddel**")

fct_sort <- nyreg_data_underkat$AAR %>% unique()

map(udvalgte_kat, ~{nyreg_data_underkat |>
        filter(ANVENDELSE==.x) %>% 
  mutate(AAR = factor(AAR, levels = fct_sort)) %>% 
  hchart('column', hcaes(x = AAR, y =ANTAL, group = DRIV ), borderColor = 0) |> 
  hc_plotOptions(column = list(stacking = "percent")) |> 
  hc_colors(c(trm_colors(farver))) |> 
  hc_yAxis(title = list(text = "Pct."), max = 100) |> 
  hc_xAxis(categories = fct_sort, title = list(text = NULL)) %>% 
  hc_legend(reversed =TRUE) %>% 
  hc_tooltip(shared = TRUE,
    pointFormat = "<b>{series.name}</b>: {point.percentage:.1f} pct. ({point.y:,.0f} lastbiler) <br>"
  )  %>% 
  format_chart(str_glue("<b>{str_replace_all(.x, c('_'=' ', 'OE'='Ø', 'AA'='Å', 'AE'='Æ')) %>% str_to_sentence()}<b>"))}) |> 
  hw_grid(rowheight = 400) %>% htmltools::browsable()

nyeste_aar_C <- as.character(nyeste_aar)


```

Bestanden af busser er forsat domineret af dieselbusser. Det gælder særligt for busser anvendt til buskørsel, hvor dieselbusser  i `r seneste_md_navn` `r nyeste_aar_C` udgjorde `r bestand_data_senestemåned_txt_diesel$Buskørsel` pct. af bestanden. 

For busser kun godkendt til rutekørsel udgjorde dieselbusser kun `r Diesel_bestand_KGR` pct. alt i mens elbusser udgjorde `r round (El_bestand_KGR)` pct. for denne anvendelseskategori.

```{r, results='asis'}
cat("**Figur 5. Bestanden fordelt på anvendelse og drivmiddel**")


fct_sor_2 <- bestand_data_underkat$AAR %>% unique()


map(udvalgte_kat, ~{bestand_data_underkat |> 
  filter(ANVENDELSE==.x) %>% 
  hchart('column', hcaes(x = AAR, y = BESTAND, group = DRIV ), borderColor = 0) |> 
  hc_plotOptions(column = list(stacking = "normal")) |> 
  hc_colors(c(trm_colors(farver))) |> 
  hc_yAxis(
    title = list(text = "BESTAND"),
    labels = list(
      format = "{value:,.0f}")
  ) |> 
  hc_xAxis(categories = fct_sor_2, title = list(text = NULL)) %>% 
  hc_tooltip(shared = TRUE,
             pointFormat = "<b>{series.name}</b>: {point.y:,.0f} lastbiler ({point.percentage:.1f} pct.) <br>"
  )  %>% 
  hc_legend(reversed =TRUE) %>% 
  format_chart(str_glue("<b>{str_replace_all(.x, c('_'=' ', 'OE'='Ø', 'AA'='Å', 'AE'='Æ')) %>% str_to_sentence()}<b>"))}) |> 
  hw_grid(rowheight = 400) %>% htmltools::browsable()

```

