---
title: "Status på elbiler"
output:
  html_document
date: "`r format(Sys.time(), '%d. %B %Y')`"
---

<style type="text/css">
.main-container {
  max-width: 700px !important;
  margin: auto;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)


library(tidyverse)
library(readxl)
library(sf)
library(TRMvisual)
library(extrafont)
library(ggrepel)
library(statbank)
library(highcharter)
library(knitr)
library(extrafont)
library(ggpp)
library(officer)

options(scipen = 100, digits = 2, decimal.mark = ",", OutDec = ",")
Sys.setenv(Lang = "da")

knit_hooks$set(inline = function(x) {
  if(is.numeric(x)){
  return(prettyNum(x, big.mark=".", digits = 1))
  } else{
    return(x)
  }
})

ft <- fp_text(font.size = 7,font.family = "Georgia")
text_fkt <- function(text){
  fpar(ftext(text, ft), fp_p = fp_par(line_spacing = 1))
}


data_bil <- tbl_dst("BIL54", "da") |> 
  filter(BILTYPE %in% c("4000101002", "4000100001"), OMRÅDE == "000", DRIV %in% c("20205", "20210", "20225", "20232"),
         BRUG %in% c("1000")) |> 
  use_labels() |> 
  collect() |> 
  select(-c("OMRÅDE", "BRUG"))

data_bil_1 <- data_bil |> 
  mutate(AAR = round(as.numeric(str_sub(TID, end=4 )) + (as.numeric(str_sub(TID, start=-2 ))-1)/12, 3),
         DATE = as.Date(str_c(str_sub(TID, end=4 ), "-", str_sub(TID, start=-2 ), "-01")),
         DATE_1 = DATE %m+% months(1),
         UDV_BIL = INDHOLD-lag(INDHOLD),
         .by = c("BILTYPE", "DRIV")) 


data_nysalg <- tbl_dst("BIL51", "da") |> 
  filter(EJER =="1000", DRIV %in% c("20205", "20210", "20225", "20233", "20234")) |> 
  use_labels() |> 
  collect() |> 
  select(-c("EJER"))

text_sidst_md <- data_nysalg |> slice_tail(n=1) |> 
  pull(TID) |> 
  (\(y) str_c(str_sub(y, end = 4), " (", month.name[as.numeric(str_sub(y, start = -2))], ")" ))()

data_nysalg_1 <- data_nysalg |> 
  mutate(DRIV = ifelse(str_detect(DRIV, "hybrid"), "Plug-in-hybrid", DRIV),
         AAR = str_sub(TID, end = 4)) |> 
  (\(y) bind_rows(group_by(y, AAR, DRIV) |> 
                    summarise(INDHOLD = sum(INDHOLD),
                              .groups = "drop_last") |> 
                    mutate(A_INDHOLD = round(INDHOLD/sum(INDHOLD)*100 ,1)) |> 
                    ungroup(), 
                  filter(y, TID==max(TID)) |> 
                              summarise(AAR = text_sidst_md,
                                        INDHOLD = sum(INDHOLD),
                                        .by = "DRIV") |> 
                              mutate(A_INDHOLD = round(INDHOLD/sum(INDHOLD)*100, 1)) |> 
                              ungroup()))() 
  
  

```

## Status på udviklingen i antallet af elbiler sammenlignet med KF23

```{r}
dat_fig_1 <- tibble("AAR"=round(sort(rep(2022:2026, 12)) + rep((c(1:12)-1)/12, 5), 3)) |> 
  mutate(KF_UDV = round(2467*exp(0.1713*(AAR-2022)),0 )) |> 
  inner_join(data_bil_1 |> 
              filter(BILTYPE=="Personbiler i alt", DRIV=="El") |> 
               mutate(vaetg_gnst = round((lag(UDV_BIL, 2)+lag(UDV_BIL)+UDV_BIL)/3, 0)) |>  
              select(-c("BILTYPE","DRIV","TID","INDHOLD")),
            by="AAR"
              ) |> 
  filter(AAR>=2023)

antal_el_biler_ialt <- dat_fig_1$UDV_BIL |> sum()
antal_el_biler_KF_est <- dat_fig_1$KF_UDV  |> sum()

pct_el_biler_ialt <- (antal_el_biler_ialt/antal_el_biler_KF_est-1)*100


```


Den faktiske udvikling i antallet af elbiler går meget hurtigere end hvad KF23 har estimeret for 2023. Den observerede tilgang af elbiler er på godt `r antal_el_biler_ialt` biler, svarende til knap `r pct_el_biler_ialt` pct. højere end estimeret i KF23 for samme periode, jf. figur 1. Elbilers tilgang i 2023 har i snit været `r antal_el_biler_ialt/month(max(dat_fig_1$DATE))` biler pr. måned, mens KF23 estimerer et snit på godt 2.900 biler. KF23 estimerer, at dette års udvikling i tilgangen af elbiler, først ville indtræffe i 2027, hvor den månedlige tilgang forventes at være godt 5.800 biler pr. måned jf. KF23.

**Figur 1. Månedlig tilgang af elbiler til bestanden opgjort i DST og KF23**
```{r}
dat_fig_1 |> 
  pivot_longer(c("KF_UDV", "UDV_BIL", "vaetg_gnst"), names_to = "VAR", values_to = "ANTAL_BILER") |> 
  (\(y) hchart(filter(y, VAR!="vaetg_gnst"),
    'line', hcaes(x = DATE, y = ANTAL_BILER, group  = VAR), marker = FALSE, name = c("Est. KF23 udvikling", "Faktisk udvikling")) |> 
  hc_colors(c(trm_colors(c("blaa", "gul")), trm_colors("gul"))) |> 
  hc_add_series(filter(y, VAR=="vaetg_gnst"), type = "line", 
                hcaes(x = DATE, y = ANTAL_BILER, group  = VAR), marker = FALSE, dashStyle = "dash", name = "3 måneders glidende gnst.") |>
    hc_yAxis(title = list(text = "Antal biler"),
                          labels = list(
                            formatter = JS("function() {
      return Highcharts.numberFormat(this.value, 0, '.', '.');
    }"))) |> 
    hc_xAxis(title = list(text = "Måned")))() 
```


```{r}
DST_tal <- data_bil_1 |>
  filter(BILTYPE=="Personbiler i alt", DRIV=="El", 
         DATE_1 %in% c(max(DATE_1), max(DATE_1) |> floor_date("years"))) |> 
  mutate(x_axis = str_c(format(DATE_1, "%d. %B %Y"), " (DST)"),
         INDHOLD,
         .keep = "none",
         .after = 1)
  
KF_tal <- tibble(x_axis = c("01. January 2024 (KF23)", "01. January 2025 (KF23)"),
       INDHOLD = c(147238, 187507)) 

slutaar_antal <- DST_tal$INDHOLD[[2]] + antal_el_biler_ialt/month(max(dat_fig_1$DATE))*(12-month(max(dat_fig_1$DATE)))
```

Udviklingen i antallet af elbiler har resulteret i, at bestanden pr. 1 august 2023 har overgået KF23’s estimat for, hvad bestanden ville være ved udgangen af 2023. Bestanden pr. `r DST_tal$x_axis[[2]] |> str_remove_all(" \\(DST\\)")` er `r DST_tal$INDHOLD[[2]]`, jf. figur 2. 

Skulle nuværende månedlige tilgangen af elbiler fortsætte året ud, vil der pr. 1. januar 2024 være godt `r slutaar_antal` elbiler. Men taget i betragtning, at der har været en tendens til at tilgangen af elbiler stiger yderligere i årets sidste måneder forventes `r slutaar_antal` biler at være i den lave ende.


**Figur 2. Status for antallet af elbiler i 2023**
```{r}

bind_rows(DST_tal, KF_tal) |> 
  hchart('column', hcaes(x = x_axis, y = INDHOLD), color = trm_colors("blaa")) |>
  hc_yAxis(title = list(text = "Antal biler (Tusind)"),
           labels = list(
             formatter = JS("function() {
      return this.value >= 1000 ? (this.value / 1000).toFixed(0) : this.value;
    }"))) |> 
  hc_xAxis(title = list(text = ""))


```



```{r}

library(readxl)

dat_fig_3 <- read_excel("Data/kf23_dataark_-_transport.xlsx", sheet = "Bestand", skip = 4, .name_repair = ~str_c("y", .x)) |> 
  rename(TYPE=1, DRIV=2) |> 
  filter(!is.na(y2019)) |> 
  mutate(DRIV = coalesce(DRIV,"Hele bestanden")) |> 
  fill(TYPE, .direction = "down") |> 
  pivot_longer(cols = starts_with("y"), names_to = "AAR", values_to = "ANTAL_BILER") |> 
  mutate(AAR=parse_number(AAR),
         UDV_ANTAL_BILER=round(ANTAL_BILER-lag(ANTAL_BILER)), 
         MD_UDV_ANTAL_BILER=round(UDV_ANTAL_BILER/12),
         .by = c("TYPE", "DRIV"))
```

Modellen bag KF23 estimerer et fald i 2023 for årlig tilgang af elbiler på 10.000 biler, fra 46.000 biler i 2022 til 36.000 biler i 2023, jf. figur 3. Dette har indtil videre ikke vist sig at holde stik da den gennemsnitlige månedlige tilgang af elbiler i 2022 lå på knap 3.800 biler, og i de første 7 måneder af 2023, har ligget på 5.600 biler. KF23 estimerer i tillæg, at årlig tilgang først skulle være over 2022 niveau i 2025.

**Figur 3. Årlig tilgang i antallet af elbiler (KF23)**
```{r}

dat_fig_3 |> 
  filter(TYPE=="Personbiler", DRIV=="BEV") |> 
  hchart('line', hcaes(x = AAR , y = UDV_ANTAL_BILER), marker = FALSE
  ) |> 
  hc_colors(c(trm_colors(c("blaa", "gul")), trm_colors("gul"))) |> 
  hc_yAxis(title = list(text = "Antal biler (Tusind)"),
           labels = list(
             formatter = JS("function() {
      return this.value >= 1000 ? (this.value / 1000).toFixed(0) : this.value;
    }"))) |> 
  hc_xAxis(title = list(text = "År"))
```


```{r}


data_fig_4 <- data_bil_1 |> 
  filter(year(DATE_1)>2019, month(DATE_1) %in% c(month(floor_date(max(DATE_1), "years")), month(max(DATE_1))),
         BILTYPE=="Personbiler i alt") |> 
  mutate(DRIV_1 = ifelse(DRIV %in% c("Benzin", "Diesel"), "Fossil biler", DRIV) |> 
           factor(levels = c("El", "Pluginhybrid", "Fossil biler")),
         AAR = year(DATE_1)) |> 
  summarise(INDHOLD = sum(INDHOLD),
            .by = c("BILTYPE", "DRIV_1", "AAR", "DATE_1") ) |> 
  mutate(UDV_ANTAL_BIL = INDHOLD-lag(INDHOLD),
         .by = c("DRIV_1", "AAR"))

tal <- data_fig_4 |> 
  filter(!is.na(UDV_ANTAL_BIL))

tal_el_2019 <- tal |> filter(DRIV_1=="El", AAR=="2020") |> pull("UDV_ANTAL_BIL")
tal_el_2023 <- tal |> filter(DRIV_1=="El", AAR=="2023") |> pull("UDV_ANTAL_BIL")
tal_fos_2019 <- tal |> filter(DRIV_1=="	Fossil biler", AAR=="2020") |> pull("UDV_ANTAL_BIL")
tal_fos_2023 <- tal |> filter(DRIV_1=="	Fossil biler", AAR=="2023") |> pull("UDV_ANTAL_BIL")
```

Bestanden af elbiler oplever en accelererende udvikling i tilgangen, hvor tilgangen var godt `r tal_el_2019` biler i første `r month(max(dat_fig_1$DATE))` måneder af 2020, mens tilgangen i første `r month(max(dat_fig_1$DATE))` måneder af 2023 var knap `r tal_el_2023` biler, jf. figur 4. Omvendt er bestanden af fossile biler gået fra en nettotilgang på godt `r tal_fos_2019` biler i første `r month(max(dat_fig_1$DATE))` måneder af 2020 til en nettoafgang på knap `r tal_fos_2023` biler i første `r month(max(dat_fig_1$DATE))` måneder af 2023. Det skyldes særligt, at bestanden af dieselbiler har været faldende siden august 2020, mens bestanden af benzinbiler har været faldende siden august 2021.

**Figur 4. Udvikling i antallet af biler til bestanden fra januar til `r month.name[month(max(dat_fig_1$DATE))]`**
```{r}

data_fig_4 |> 
  filter(!is.na(UDV_ANTAL_BIL)) |> 
  hchart('column', hcaes(x = AAR, y = UDV_ANTAL_BIL, group = DRIV_1 )) |> 
  hc_colors(c(trm_colors(c("blaa", "orange", "graa")))) |> 
  hc_yAxis(title = list(text = "Antal biler (Tusind)"),
           labels = list(
             formatter = JS("function() {
      return this.value ? (this.value / 1000).toFixed(0) : this.value;
    }"))) |> 
  hc_xAxis(title = list(text = "År"))
```



```{r}

sidste_par_aar <- data_bil_1 |> 
  filter(BILTYPE=="Personbiler i alt" & year(DATE)>2018 & year(DATE)>(max(year(DATE))-6) & year(DATE)<max(year(DATE))) |> 
  (\(y) bind_rows(y |> filter(year(DATE)==max(year(DATE))) |> 
                    mutate(MD = month(DATE), DRIV, UDV_BIL, TYPE = "Sidste år",
                           .keep = "none"),
                  y |> 
                    mutate(MD = month(DATE)) |> 
                    summarise(UDV_BIL = mean(UDV_BIL), TYPE = "Gnst. sidste 5 år",
                              .by = c("MD", "DRIV"))
                  ))()

dette_par_aar <- data_bil_1 |> 
  filter(BILTYPE=="Personbiler i alt" & year(DATE)==max(year(DATE))) |> 
  mutate(MD = month(DATE), DRIV, UDV_BIL, TYPE = "I år", .keep = "none")



```



**Figur 5. Udvikling pr måned i antallet af biler fordelt på drivmiddel**
```{r}

map(sidste_par_aar$DRIV |> unique(), 
    ~hchart(sidste_par_aar |> filter(DRIV ==.x), 'line', hcaes(x = month.abb[MD], y = UDV_BIL, group = TYPE ), marker = F) |> 
  hc_colors(c(trm_colors(c("orange", "graa")))) |> 
  hc_add_series(filter(dette_par_aar, DRIV ==.x), type = "column", 
                hcaes(x = month.abb[MD], y = UDV_BIL), color = trm_colors(c("blaa")), name = "Årets udvikling") |> 
    hc_title(text = .x) |> 
  hc_yAxis(title = list(text = "Antal biler (Tusind)"),
           labels = list(
             formatter = JS("function() {
      return this.value ? (this.value / 1000).toFixed(0) : this.value;
    }"))) |> 
  hc_xAxis(title = list(text = "Måned"))) |> 
  hw_grid(rowheight = 600) %>% htmltools::browsable()

```


**Figur 6. Drivmidlers andel af nybilssalget**
```{r}

data_nysalg_1 |> 
  filter(as.numeric(str_sub(AAR, end = 4))>max(as.numeric(str_sub(AAR, end = 4)))-5) |> 
  hchart('column', hcaes(x = AAR, y =A_INDHOLD, group = DRIV )) |> 
  hc_plotOptions(column = list(stacking = "normal")) |> 
  hc_colors(c(trm_colors(c("gul", "graa", "orange","blaa")))) |> 
  hc_yAxis(title = list(text = "Andel i pct."), max = 100) |> 
  hc_xAxis(title = list(text = "År"))

```


