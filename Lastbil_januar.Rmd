---
title: "Lastbiler"
output: 
  html_document:
    css: styles.css
date: 'Opdateret `r format(Sys.Date(), "%d. %B %Y")`'
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
extrafont::loadfonts()
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# ---- INDLEDNING ----


library(downloadthis)
library(tidyverse)
library(readxl)
library(sf)
library(TRMvisual)
library(extrafont)
library(statbank)
library(highcharter)
library(knitr)
library(extrafont)
library(ggpp)
library(officer)
library(lubridate)
library(plotly)
library(scales)
library(downloadthis)
library(zoo)
library(htmltools)


  
lang <- getOption("highcharter.lang")
lang$decimalPoint <- ","
lang$thousandsSep <- "."
lang$numericSymbols <- highcharter::JS("null") # optional: remove the SI prefixes
options(highcharter.lang = lang)

options(scipen = 1000, digits = 2, decimal.mark = ",", OutDec = ",")
Sys.setenv(Lang = "da")

knit_hooks$set(inline = function(x) {
  if(is.numeric(x)){
    return(prettyNum(x, big.mark=".", digits = 2))
  } else{
    return(x)
  }
})

if(month(Sys.Date())==1){
  stjerne <- ""
  stjerne_tekst <- ""
} else{
    stjerne <- "*"
    stjerne_tekst <- "*År til dato"
  }

sti_kf <- "S:/CKA/Databank/007 Klimafremskrivning"
sti <- "S:/CKA/Databank/006 Bilstatistik/Lastbil"


# ---- BESTAND  ----


# Define a function to process bestand data based on a specific pattern
process_bestand_data <- function(sti, pattern) {
  dir(sti) %>%
    str_subset(pattern) %>%
    map_dfr(~read_excel(str_c(sti, "/", .x), skip = 9,
                        .name_repair = ~str_to_upper(.x) %>% 
                          str_replace_all(c(" |\\,|\\.|-|\\/|\\(|\\)"="_", "Å"="AA", "Æ"="AE", "Ø"="OE", "__"="_"))) %>%
              select(-NR_) %>%
              pivot_longer(cols = -"DRIVKRAFT", names_to = "KASSORI", values_to = "ANTAL") %>%
              arrange(KASSORI, DRIVKRAFT) %>%
              mutate(
                DRIVKRAFT_CLEANED = str_extract(DRIVKRAFT, "PHEV|El") %>% 
                  coalesce(DRIVKRAFT),
                DRIV = case_when(
                  DRIVKRAFT_CLEANED %in% c("Benzin", "PHEV", "Brint", "Ukendt") ~ "Øvrige drivmidler",
                  DRIVKRAFT_CLEANED == "Total for rapport" ~ "Total",
                  TRUE ~ DRIVKRAFT_CLEANED
                ) %>%
                  factor(levels = c("Øvrige drivmidler", "Diesel", "Gas", "El", "Total")),
                DATE = parse_number(.x, locale = locale(grouping_mark = "-")),
                DATE = dmy(DATE)
              ) %>%
              select(-DRIVKRAFT)
    ) %>%
    summarise(ANTAL = sum(ANTAL), .by = c("KASSORI", "DATE", "DRIV"))
}

# Use the function with different patterns for gamle, tunge, and lette
bestand_data_gamle <- process_bestand_data(sti, "Bestand(?!.*lette|.*tunge)")
bestand_data_tunge <- process_bestand_data(sti, "Bestand.*tunge")
bestand_data_lette <- process_bestand_data(sti, "Bestand.*lette")


bestand_data <- bind_rows(
  bestand_data_lette %>% mutate(TUNG = 0),
  bestand_data_tunge %>% mutate(TUNG = 1)
)


bestand_data_ny <- bestand_data %>%
  select(-TUNG) %>%
    filter(DATE >= as.Date("2024-10-31")) %>%
    group_by(DRIV, DATE, KASSORI) %>%
  summarise(ANTAL = sum(ANTAL, na.rm = TRUE), .groups = "drop") %>%
    arrange(DATE, DRIV)

bestand_data_samlet_gammel_metode <- bind_rows(
  bestand_data_gamle,
  bestand_data_ny
)

nummer_sidste_md <- bestand_data$DATE %>% max() %>% month()
nummer_næst_sidste_md <- bestand_data$DATE %>% max() %>% month() - 1
nyeste_aar <- bestand_data$DATE %>% max() %>% year()

process_bestand_data <- function(data) {
  data %>% 
    filter(DRIV != "Total", KASSORI == "TOTAL", month(DATE) == 12 | DATE == max(DATE)) %>% 
    summarise(ANTAL = sum(ANTAL), .by = c("DATE", "DRIV")) %>% 
    mutate(
      AAR = ifelse(month(max(DATE)) != 12, 
                   str_c(year(DATE), " (", format(DATE, "%B"), ")"), 
                   as.character(year(DATE) + 1)), 
      A_BESTAND = ANTAL / sum(ANTAL) * 100, 
      .by = c("DATE")
    ) %>% 
    select(AAR, DRIV, ANTAL, A_BESTAND) %>% 
    arrange(AAR)
}


#Definerer en funktion der tilføjer stjerne til det år man vælger
add_star_to_year <- function(df, year) {
  # Ensure the 'AAR' column exists
  if ("AAR" %in% colnames(df)) {
    df <- df %>%
      mutate(AAR = ifelse(AAR == as.character(year), paste0(year, "*"), AAR))
  } else {
    warning("Column 'AAR' not found in the dataframe.")
  }
  return(df)
}


# Process and assign directly to the global environment
list2env(
  map(list(
    bestand_data_1 = bestand_data,
    bestand_data_1_lette = bestand_data_lette,
    bestand_data_1_tunge = bestand_data_tunge
  ), process_bestand_data),
  envir = .GlobalEnv
)


# Process and assign directly to the global environment
list2env(
  map(list(
    bestand_data_1_stjerne = bestand_data_1,
    bestand_data_1_lette_stjerne = bestand_data_1_lette,
    bestand_data_1_tunge_stjerne = bestand_data_1_tunge
  ), ~ add_star_to_year(.x, year = "2024")), # Apply year = "2024"
  envir = .GlobalEnv
)

bestand_data_udv <- bestand_data_samlet_gammel_metode %>% 
  filter(KASSORI == "TOTAL", month(DATE) == 12 | month(DATE) == nummer_sidste_md) %>% 
  mutate(AAR = ifelse(month(DATE) != 12, 
                      year(DATE), 
                      year(DATE) + 1)) %>% 
  arrange(DRIV, DATE) %>% 
  group_by (DRIV) %>%  # Group by AAR and DRIV
  mutate(lag_antal = lag(ANTAL)) %>%  # Calculate lag within each group
  filter(AAR > 2019, !is.na(lag_antal)) %>% 
  mutate(UDV = ANTAL - lag_antal,
         DRIV = factor(DRIV, 
                       levels = c("El", "Gas", "Diesel", "Øvrige drivmidler", "Total")),
         .keep = "unused") %>% 
  select(-KASSORI) %>% 
  distinct(AAR, DRIV, .keep_all = TRUE) %>%  # Remove duplicate combinations of AAR and DRIV
  arrange(AAR)




bestand_data_2 <- bestand_data %>% 
  filter(DRIV != "Total", KASSORI == "TOTAL") %>%
  filter(DATE == sort(unique(DATE), decreasing = TRUE)[2]) %>%  # Get the second newest date
  summarise(ANTAL = sum(ANTAL), 
            .by = c("DATE", "DRIV")) %>% 
  mutate(AAR = ifelse(month(DATE) != 12, 
                      str_c(year(DATE), " (", format(DATE, "%B"), ")"), 
                      as.character(year(DATE) + 1)), 
         A_BESTAND = ANTAL / sum(ANTAL) * 100,
         .by = c("DATE")) %>% 
  select(AAR, DRIV, ANTAL, A_BESTAND) %>% 
  arrange(AAR)
  




# ---- NYREG ----

nyreg_data_lette <- dir(sti) %>% 
  # Filter for files with "Nyregistreringer" and "lette" in the filename
  str_subset("Nyregistreringer.*lette") %>% 
  map_dfr(function(y) 
    read_excel(
      str_c(sti, "/", y), 
      skip = 9,
      .name_repair = ~str_to_upper(.x) %>% 
                     str_replace_all(c(" |\\,|\\.|-|\\/|\\(|\\)" = "_", "Å" = "AA", "Æ" = "AE", "Ø" = "OE", "__" = "_"))
    ) %>% 
      select(-NR_) %>%  # Remove unnecessary column `NR_`
      
      # Transform data from wide to long format
      pivot_longer(cols = -"DRIVKRAFT", names_to = "KASSORI", values_to = "ANTAL") %>% 
      arrange(KASSORI, DRIVKRAFT) %>% 
      
      # Data cleaning and manipulation
      mutate(
        # Extract "PHEV" or "El" if present, otherwise keep `DRIVKRAFT` as is
        DRIVKRAFT = str_extract(DRIVKRAFT, "PHEV|El") %>% 
                    na_if("") %>% 
                    coalesce(DRIVKRAFT), 
        
        # Recode `DRIV` based on `DRIVKRAFT` values
        DRIV = case_when(
          DRIVKRAFT %in% c("Benzin", "PHEV", "Brint", "Ukendt") ~ "Øvrige drivmidler",
          DRIVKRAFT == "Total for rapport" ~ "Total",
          TRUE ~ DRIVKRAFT
        ) %>% factor(levels = c("Øvrige drivmidler", "Diesel", "Gas", "El", "Total")),
        
        # Extract all dates in DD-MM-YYYY format from the string and parse them
        DATE_RANGE = str_extract_all(y, "\\d{2}-\\d{2}-\\d{4}"),
        
        # Assign first extracted date as DATE1 and second as DATE2, if both are present
        DATE1 = map_chr(DATE_RANGE, ~ .x[1] %||% NA_character_),
        DATE2 = map_chr(DATE_RANGE, ~ .x[2] %||% NA_character_),
        
        # Convert to date objects
        DATE_ST = lubridate::dmy(DATE1),
        DATE_SL = lubridate::dmy(DATE2),
        AAR = year(DATE_ST) %>% as.character())) %>% 
  select(-DATE1, -DATE2, -DATE_RANGE)


nyreg_data_tunge <- dir(sti) %>% 
  # Filter for files with "Nyregistreringer" and "lette" in the filename
  str_subset("Nyregistreringer.*tunge") %>% 
  map_dfr(function(y) 
    read_excel(
      str_c(sti, "/", y), 
      skip = 9,
      .name_repair = ~str_to_upper(.x) %>% 
                     str_replace_all(c(" |\\,|\\.|-|\\/|\\(|\\)" = "_", "Å" = "AA", "Æ" = "AE", "Ø" = "OE", "__" = "_"))
    ) %>% 
      select(-NR_) %>%  # Remove unnecessary column `NR_`
      
      # Transform data from wide to long format
      pivot_longer(cols = -"DRIVKRAFT", names_to = "KASSORI", values_to = "ANTAL") %>% 
      arrange(KASSORI, DRIVKRAFT) %>% 
      
      # Data cleaning and manipulation
      mutate(
        # Extract "PHEV" or "El" if present, otherwise keep `DRIVKRAFT` as is
        DRIVKRAFT = str_extract(DRIVKRAFT, "PHEV|El") %>% 
                    na_if("") %>% 
                    coalesce(DRIVKRAFT), 
        
        # Recode `DRIV` based on `DRIVKRAFT` values
        DRIV = case_when(
          DRIVKRAFT %in% c("Benzin", "PHEV", "Brint", "Ukendt") ~ "Øvrige drivmidler",
          DRIVKRAFT == "Total for rapport" ~ "Total",
          TRUE ~ DRIVKRAFT
        ) %>% factor(levels = c("Øvrige drivmidler", "Diesel", "Gas", "El", "Total")),
        
        # Extract all dates in DD-MM-YYYY format from the string and parse them
        DATE_RANGE = str_extract_all(y, "\\d{2}-\\d{2}-\\d{4}"),
        
        # Assign first extracted date as DATE1 and second as DATE2, if both are present
        DATE1 = map_chr(DATE_RANGE, ~ .x[1] %||% NA_character_),
        DATE2 = map_chr(DATE_RANGE, ~ .x[2] %||% NA_character_),
        
        # Convert to date objects
        DATE_ST = lubridate::dmy(DATE1),
        DATE_SL = lubridate::dmy(DATE2),
        AAR = year(DATE_ST) %>% as.character())) %>% 
  select(-DATE1, -DATE2, -DATE_RANGE)



nyreg_data <- bind_rows(
  nyreg_data_lette %>% mutate(TUNG = 0),
  nyreg_data_tunge %>% mutate(TUNG = 1)
)


process_nyreg_data <- function(data, date_column) {
  data %>% 
    filter(DRIV != "Total", KASSORI == "TOTAL") %>%
    (\(y) bind_rows(
      # Summarize data by year and DRIV
      summarise(y, ANTAL = sum(ANTAL), .by = c("AAR", "DRIV")),
      
      # Process the latest month data
      filter(y, !!sym(date_column) == max(!!sym(date_column))) %>%
        group_by(DRIV) %>%
        summarise(
          ANTAL = sum(ANTAL), 
          DATE_ST = max(!!sym(date_column)), 
          .groups = "drop"
        ) %>%  
        mutate(AAR = str_c(year(DATE_ST), " (", format(DATE_ST, "%B"), ")")) %>% 
        select(AAR, DRIV, ANTAL)
    ))() %>% 
    mutate(A_NYREG = round(ANTAL / sum(ANTAL) * 100, 1), .by = "AAR") %>% 
    arrange(AAR)
}


# Process each dataset and assign results directly to the global environment
list2env(
  map(
    list(
      nyreg_data_1 = list(data = nyreg_data, date_column = "DATE_ST"),
      nyreg_data_1_lette = list(data = nyreg_data_lette, date_column = "DATE_SL"),
      nyreg_data_1_tunge = list(data = nyreg_data_tunge, date_column = "DATE_SL")
    ),
    ~ process_nyreg_data(.x$data, .x$date_column)
  ),
  envir = .GlobalEnv
)



# Process and assign directly to the global environment
list2env(
  map(list(
    nyreg_data_1_stjerne = nyreg_data_1,
    nyreg_data_1_lette_stjerne = nyreg_data_1_lette,
    nyreg_data_1_tunge_stjerne = nyreg_data_1_tunge
  ), ~ add_star_to_year(.x, year = "2024")), # Apply year = "2024"
  envir = .GlobalEnv
)


# ---- DIVERSE ----


KF_salg <- read_excel(str_c(sti_kf, "/", "KF24_dataark_Transport.xlsx"),
                      sheet = "Salg", skip = 4) %>%
  rename("type" = 1, drivmiddel = 2) %>%
  filter(!if_all(.cols = everything(), .fns = ~is.na(.x))) %>%
  mutate(drivmiddel = coalesce(drivmiddel, "Total")) %>%
  fill(type) %>%
  # Ensure all columns for pivot_longer are numeric or character as needed
  mutate(across(matches("\\d+"), as.character)) %>%
  pivot_longer(
    cols = matches("\\d+"),
    names_to = "aar",
    values_to = "antal"
  ) %>%
  mutate(antal = round(as.numeric(antal), 0))  # sikrer at 'antal' er numeric

KF_bestand <- read_excel(str_c(sti_kf, "/", "KF24_dataark_Transport.xlsx"),
           sheet = "Bestand", skip =4) %>% 
  rename("type"=1, drivmiddel = 2) %>% 
  filter(!if_all(.fns =~is.na(.x))) %>% 
  mutate(drivmiddel =coalesce(drivmiddel, "Total")) %>% 
  fill(type) %>% 
  summarise(across(where(is.double), sum),
            .by = c("type","drivmiddel")) %>% 
  pivot_longer(cols = matches("\\d+"), names_to = "aar", values_to = "antal") %>% 
  mutate(antal = round(antal, 0))

KF_tal <- KF_bestand %>% 
  filter(type=="Lastbiler", drivmiddel =="BEV") %>% 
  mutate(aar = parse_number(aar),
         x_axis = str_glue("1. januar {aar+1} forventet (KF24)"),
         oprindelse = "KF") %>% 
  filter(aar %in% c(nyeste_aar, nyeste_aar+1)) %>% # TODO: Når KF24 kommer skal denne rettes til
  select(ANTAL=antal, x_axis, oprindelse)
  


nyreg_data_uden_vægt <- nyreg_data %>%
  select(-TUNG) %>%
  group_by(DRIV, DATE_SL, KASSORI, AAR) %>%
  summarise(ANTAL = sum(ANTAL, na.rm = TRUE), .groups = "drop") %>%
  arrange(DATE_SL, DRIV)


udvalgte_kat <- c("RENOVATIONSAGGREGAT", "KOELEANLAEG", "LUKKET_KASSE", "LAESSEBAGSMAEK", "TANK", "LAESSEKRAN") %>% 
  factor(., levels = .)

nyreg_data_underkat <- nyreg_data_uden_vægt %>% 
  filter(DRIV !="Total", KASSORI %in% udvalgte_kat) |>
  (\(y) bind_rows(summarise(y, ANTAL = sum(ANTAL), 
                            .by = c("AAR","KASSORI", "DRIV")),
                  filter(y, DATE_SL==max(DATE_SL)) %>% 
                    mutate(AAR = str_c(year(DATE_SL), " (", format(DATE_SL, "%B"), ")")) %>% 
                    select(AAR, DRIV, ANTAL, KASSORI)))() %>% 
  mutate(A_NYREG = round(ANTAL/sum(ANTAL)*100,1),
         .by = c("AAR", "KASSORI")) %>% 
  arrange(AAR)

bestand_data_underkat <- bestand_data %>% 
  filter(DRIV != "Total", KASSORI %in% udvalgte_kat, month(DATE) == 12 | DATE == max(DATE)) %>% 
  summarise(ANTAL = sum(ANTAL), .by = c("DATE", "KASSORI", "DRIV")) %>% 
  mutate(AAR = ifelse(month(max(DATE)) != 12, 
                      str_c(year(DATE), " (", format(DATE, "%B"), ")"), 
                      as.character(year(DATE) + 1)), 
         .by = c("DATE", "KASSORI")) %>% 
  select(AAR, KASSORI, DRIV, ANTAL) %>%
  mutate(A_BESTAND = round(ANTAL / sum(ANTAL) * 100, 1), 
         .by = c("AAR", "KASSORI")) %>%  
  arrange(AAR)

totalsalg_seneste <- nyreg_data_1 %>% filter(AAR==nyeste_aar) %>% pull(ANTAL) %>% sum()
elsalg_seneste <- nyreg_data_1 %>% filter(AAR==nyeste_aar, DRIV=="El") %>% pull(ANTAL) %>% sum()


totalsalg_seneste_lette <- nyreg_data_1_lette %>% filter(AAR==nyeste_aar) %>% pull(ANTAL) %>% sum()
elsalg_seneste_lette <- nyreg_data_1_lette %>% filter(AAR==nyeste_aar, DRIV=="El") %>% pull(ANTAL) %>% sum()


totalsalg_seneste_tunge <- nyreg_data_1_tunge %>% filter(AAR==nyeste_aar) %>% pull(ANTAL) %>% sum()
elsalg_seneste_tunge <- nyreg_data_1_tunge %>% filter(AAR==nyeste_aar, DRIV=="El") %>% pull(ANTAL) %>% sum()


totalsalg_naestseneste <- nyreg_data_1 %>%  filter(AAR==nyeste_aar-1) %>% pull(ANTAL) %>% sum()
elsalg_naestseneste <- nyreg_data_1 %>%  filter(AAR==nyeste_aar-1, DRIV=="El") %>% pull(ANTAL) %>% sum()


```

```{r globale variable til tekst}



# totalsalg_21 <- nyreg_data_1 %>% filter(year(DATE)==2021) %>% pull(ANTAL) %>% sum()
# elsalg_21 <- nyreg_data_1 %>% filter(year(DATE)==2021, DRIV=="El") %>% pull(ANTAL) %>% sum()



seneste_md <- format(ISOdate(2000, nummer_sidste_md, 1), "%B") 
seneste_md_tal <- nyreg_data_1 %>% 
  filter(str_detect(AAR, "\\("), DRIV=="El") %>% 
  pull("A_NYREG")


bestand_2021 <- bestand_data_1 %>% filter(AAR=="2021") %>% pull("ANTAL") %>% sum()
bestand_seneste <- bestand_data_1 %>%
  filter(if (any(str_detect(AAR, "\\("))) {
    str_detect(AAR, "\\(")
  } else {
    AAR == "2025"
  }) %>%
  pull("ANTAL") %>%
  sum()
bestand_seneste_lette <- bestand_data_1_lette %>% filter(if (any(str_detect(AAR, "\\("))) {
    str_detect(AAR, "\\(")
  } else {
    AAR == "2025"
  }) %>% pull("ANTAL") %>% sum()
bestand_seneste_tunge <- bestand_data_1_tunge %>% filter(if (any(str_detect(AAR, "\\("))) {
    str_detect(AAR, "\\(")
  } else {
    AAR == "2025"
  }) %>% pull("ANTAL") %>% sum()

elbestand_seneste <- bestand_data_1 %>%
  filter(if (any(str_detect(AAR, "\\("))) {
    str_detect(AAR, "\\(")
  } else {
    AAR == "2025"
  }, DRIV=="El") %>% pull("ANTAL")


elbestand_seneste_lette <- bestand_data_1_lette %>% filter(if (any(str_detect(AAR, "\\("))) {
    str_detect(AAR, "\\(")
  } else {
    AAR == "2025"
  }, DRIV=="El") %>% pull("ANTAL")
elbestand_seneste_tunge <- bestand_data_1_tunge %>% filter (if (any(str_detect(AAR, "\\("))) {
    str_detect(AAR, "\\(")
  } else {
    AAR == "2025"
  }, DRIV=="El") %>% pull("ANTAL")
elbestand_næst_seneste <- bestand_data_2 %>% filter(str_detect(AAR, "\\("), DRIV=="El") %>% pull("ANTAL")
udv_elbestand_seneste_måned <- elbestand_seneste - elbestand_næst_seneste

# 
# Alt imens bestanden af elbiler er under udvikling, er bestanden af fossilbiler gået fra en nettotilgang på  `r tal_fos_2019` biler i de første `r month(max(dat_fig_3$DATE))` måneder af 2020 til en nettoafgang på `r tal_fos_2023` biler i de første `r month(max(dat_fig_3$DATE))` måneder af 2023. Det skyldes særligt, at bestanden af dieselbiler har været faldende siden august 2020, mens bestanden af benzinbiler har været faldende siden august 2021.
# 
# Af figuren fremgår det yderligere, at væksten i bestanden af plug-in-bybrid biler foreløbigt er toppet i `r sprintf("%.0f", max_year_P_I_H)`.

  
# <- bestand_data_1 %>% filter(AAR=="2020") %>% pull(ANTAL) %>% sum()
# bestand_seneste <- bestand_data_1 %>% filter(AAR==max(AAR)) %>% pull(ANTAL) %>% sum()
# elbestand_seneste <- bestand_data_1 %>% filter(AAR==max(AAR), DRIV=="El") %>% pull(ANTAL) %>% sum()

```



```{r}

figur_1_og_2 <- nyreg_data_1 %>% 
  select(år=AAR, 
         drivmiddel=DRIV,
         antal =ANTAL,
         andel = A_NYREG)

figur_1_2_lette <- nyreg_data_1_lette %>% 
  select(år=AAR, 
         drivmiddel=DRIV,
         antal =ANTAL,
         andel = A_NYREG)

figur_1_2_tunge <- nyreg_data_1_tunge %>% 
  select(år=AAR, 
         drivmiddel=DRIV,
         antal =ANTAL,
         andel = A_NYREG)



 
figur_3 <- bestand_data_1 |>
  select(år = AAR,
         drivmiddel=DRIV,
         antal =ANTAL , 
         andel = A_BESTAND
  ) 

figur_3_lette <- bestand_data_1_lette|>
  select(år = AAR,
         drivmiddel=DRIV,
         antal =ANTAL , 
         andel = A_BESTAND
  ) 

figur_3_tunge <- bestand_data_1_tunge |>
  select(år = AAR,
         drivmiddel=DRIV,
         antal =ANTAL , 
         andel = A_BESTAND
  ) 


figur_4 <- bestand_data_1 %>% 
  filter(AAR %in% c(nyeste_aar-1,nyeste_aar), DRIV =="El") %>% 
  mutate(x_axis = str_c("1. januar", AAR),
         oprindelse = "Bilstatistik",
         ANTAL,
         .keep = "none") %>%
  bind_rows(KF_tal) %>% 
  select(kilde = oprindelse,
         dato=x_axis, 
         antal =ANTAL)


 
figur_5 <- bestand_data_udv |> 
  arrange(AAR, desc(DRIV)) |>
  select(år = AAR,
         drivmiddel=DRIV,
         antal =UDV 
  )

  figur_6 <- nyreg_data_underkat |> 
  arrange(KASSORI, AAR, desc(DRIV)) |>
  mutate(år = AAR,
         kassori = str_replace_all(KASSORI, '_', ' ') %>% 
                          str_to_sentence(),
         drivmiddel=DRIV,
         antal =ANTAL,
         andel = A_NYREG,
         .keep = "none"
  ) 
  
figur_7 <- bestand_data_underkat |> 
  arrange(KASSORI, AAR, desc(DRIV)) |>
    mutate(år = AAR,
         kassori = str_replace_all(KASSORI, '_', ' ') %>% 
                          str_to_sentence(),
         drivmiddel=DRIV,
         antal =ANTAL,
         andel = A_BESTAND,
         .keep = "none"
  ) 

thm <- hc_theme(
      chart = list(
        style = list(
          fontFamily = "Georgia"
        )
      )
)


```


Dette er Transportministeriets interne statusnotat for nyregistreringer og bestand af lastbiler. Det viser bl.a. udviklingen i antallet af lastbiler fordelt på drivmiddeltyper. Notatet opdateres månedsvis og er baseret på data fra Bilstatistik.  

Data fra rapporten kan hentes her:
```{r}
list("Figur 1 og 2 samlet" = figur_1_og_2, "Figur 1 og 2 lette" = figur_1_2_lette, "Figur 1 og 2 tunge" = figur_1_2_tunge, "Figur 3 samlet" = figur_3,"Figur 3 lette" = figur_3_lette, "Figur 3 tunge" = figur_3_tunge, "Figur 4" = figur_4, "Figur 5" = figur_5,
     "Figur 6" = figur_6, "Figur 7" = figur_7) %>%
  download_this(
    output_name = "Data til rapport om status på lastbilsudviklingen",
    output_extension = ".xlsx",
    button_label = "Download datasæt",
    button_type = "info",
    has_icon = TRUE,
    icon = "fa fa-save"
  )
```


### Status på udviklingen af bestanden
I løbet af `r as.character(nyeste_aar)` er der nyregistreret `r totalsalg_seneste` lastbiler, hvoraf `r elsalg_seneste` er ellastbiler. Til sammenligning blev der i `r as.character(nyeste_aar-1)` nyregistreret `r elsalg_naestseneste` ellastbiler.


```{r}
#Figur 1. Udvikling i nyregistreringer af lastbiler fordelt på drivmiddel

farver <- c("graa",  "blaa", "orange","groen") %>% factor(., levels = .)

nyreg_data_1_stjerne <- nyreg_data_1 %>%
  mutate(AAR = ifelse(AAR == nyeste_aar, paste0(AAR, stjerne), AAR))

nyreg_data_1_stjerne |> 
  filter(!str_detect(AAR, "\\(|9")) |># Exclude rows where AAR contains "(" or "9"
  hchart('column', hcaes(x = AAR, y =ANTAL, group = DRIV ), borderColor = 0,
         style = list(useHTML = TRUE, font = "Georgia")) %>%
  
  hc_plotOptions(column = list(stacking = "normal")) |> 
  hc_colors(c(trm_colors(farver))) |> 
  hc_yAxis(title = list(text = "Antal"),
           labels = list(format = "{value:,.0f}"),
           stackLabels = list(enabled = TRUE, verticalAlign = 'top',
                              crop = FALSE, overflow = 'none')) |> 
  hc_xAxis(title = list(text = NULL)
           # labels = list(
           #   formatter = JS("
           #     function() {
           #       if (this.isLast) {
           #         return this.value + '*'; // Add a '*' to the last category
           #       }
           #       return this.value;
           #     }
           #    "))
  ) %>% 
  hc_legend(reversed =TRUE) %>% 
  hc_tooltip(shared = TRUE,
             pointFormat = "<b>{series.name}</b>: {point.percentage:.1f} pct. ({point.y:,.0f} lastbiler) <br>") %>%
  trm_hc_format("<b>Figur 1.</b> Udvikling i nyregistreringer af lastbiler fordelt på drivmiddel",
                note = str_glue("Kilde: Bilstatistik<br>{stjerne_tekst}"))




```

Ellastbilers andel af det samlede antal nyregistreringer har været svagt stigende siden 2021.  I  `r str_c(seneste_md)` måned udgjorde ellastbiler  `r seneste_md_tal` pct. af de samlede nyregistreringer, hvor ellastbiler i gennemsnit hidtil har  udgjort  `r elsalg_seneste/totalsalg_seneste*100` pct. af de samlede nyregistreringer i `r as.character(nyeste_aar)`. Til sammenligning udgjorde ellastbiler `r elsalg_naestseneste/totalsalg_naestseneste*100` pct. af de samlede nyregistreringer i `r as.character(nyeste_aar-1)`. 

```{r}
#Figur 2. Drivmidlernes andel af nyregistreringer
nyreg_data_1_stjerne <- nyreg_data_1 %>%
  mutate(AAR = ifelse(AAR == nyeste_aar, paste0(AAR, stjerne), AAR))

fct_sort_stjerne <- nyreg_data_1_stjerne$AAR %>% unique()

nyreg_data_1_stjerne |> 
  filter(!str_detect(AAR, "9")) |># Exclude rows where AAR CONTATINS "9"
  mutate(AAR = factor(AAR, levels = fct_sort_stjerne),
         antal = ANTAL) %>%  # Add ANTAL column for use in the tooltip
  hchart('column', hcaes(x = AAR, y =A_NYREG , group = DRIV ), borderColor = 0) |> 
  hc_plotOptions(column = list(stacking = "normal"), style = list(
    fontFamily = "Georgia"
  )) |> 
  hc_colors(c(trm_colors(farver))) |> 
  hc_yAxis(title = list(text = "Pct."), max = 100) |> 
  hc_xAxis(title = list(text = NULL), categories = fct_sort_stjerne,
           labels = list(rotation = -30)  # Tilt the labels by -45 degrees (you can adjust the angle)
  ) %>% 
  hc_legend(reversed =TRUE) %>%

  hc_tooltip(shared = TRUE,
             pointFormat = "<b>{series.name}</b>: {point.percentage:.1f} pct. (<b>{point.antal:,.0f}</b> lastbiler)<br>") %>%
  trm_hc_format("<b>Figur 2.</b> Drivmidlernes andel af nyregistreringer",
                note = str_glue("Kilde: Bilstatistik<br>{stjerne_tekst}"))

```






```{r, results='asis'}
#Faktaboks

graa_2 = "#EDF1F4"

formatted_text <- div(
 style = sprintf("background-color: %s; padding: 5px 20px; border: 1px solid #ddd; 
                   font-family: inherit; font-size: inherit; 
                   max-width: 700px; margin: auto;", graa_2),
          h3("Faktaboks", style = "margin-top: 0.5;"), #
           p("I indeværende notat defineres lastbiler med en vægt på 4.250 kg. og derunder som lette lastbiler.
    Lastbiler med en vægt over 4.250 kg. defineres som tunge lastbiler. Det bør bemærkes, at der i andre sammenhænge kan forekomme andre definitnioner af henholdsvis lette og tunge lastibler."))
  
  
browsable(formatted_text)

```



Opdeles lastibler efter vægt, fremgår det, at det primært er de lette lastbiler, der omstilles til eldrift. Foreløbigt i `r as.character(nyeste_aar)`  har ellastbiler udgjort `r elsalg_seneste_lette/totalsalg_seneste_lette*100` pct. af alle nyregistreringer for kategorien lette lastbiler, jf. figur 2.1. For tunge lastbiler har  ellastbiler i samme periode kun udgjort `r elsalg_seneste_tunge/totalsalg_seneste_tunge*100` pct. af nyregistreringerne, jf. figur 2.2.


```{r}
#Figur 2.1 Drivmidlernes andel af nyregistreringer for lette lastbiler
nyreg_data_1_lette_stjerne <- nyreg_data_1_lette %>%
  mutate(AAR = ifelse(AAR == nyeste_aar, paste0(AAR, stjerne), AAR))

fct_sort <- nyreg_data_1_lette_stjerne$AAR %>% unique()

figur2_lette <- nyreg_data_1_lette_stjerne |>
  filter(!str_detect(AAR, "9")) |># Exclude rows where AAR CONTATINS "9"
  mutate(AAR = factor(AAR, levels = fct_sort),
         antal = ANTAL) %>%  # Add ANTAL column for use in the tooltip
  hchart('column', hcaes(x = AAR, y =A_NYREG , group = DRIV ), borderColor = 0) |> 
  hc_plotOptions(column = list(stacking = "normal"), style = list(
    fontFamily = "Georgia"
  )) |> 
  hc_colors(as.character(trm_colors(farver[c(2, 4)]))) |>  # Use only "blaa" and "groen" (the second and fourth colors)
  hc_yAxis(title = list(text = "Pct."), max = 100) |> 
  hc_xAxis(title = list(text = NULL), categories = fct_sort,
           labels = list(rotation = -30)  # Tilt the labels by -45 degrees (you can adjust the angle)
  ) %>% 
  hc_legend(reversed = TRUE, 
            layout = "horizontal", 
            align = "center", 
            verticalAlign = "bottom",
            itemStyle = list(fontSize = "11px"),
            itemDistance = 2 )%>% 
  hc_chart(marginBottom = 180)  %>%
  hc_tooltip(shared = TRUE,
             pointFormat = "<b>{series.name}</b>: {point.percentage:.1f} pct. (<b>{point.antal:,.0f}</b> lastbiler)<br>") %>%
  trm_hc_format("<b>Figur 2.1</b> Drivmidlernes andel af nyregistreringer for lette lastbiler",
                note = str_glue("Kilde: Bilstatistik<br>Note: Lette lastibler dækker over lastbiler med en på vægt på 4.250 kg. og nedefter.<br>{stjerne_tekst}"))



#Figur 2.2 Drivmidlernes andel af nyregistreringer for tunge lastbiler
nyreg_data_1_tunge_stjerne <- nyreg_data_1_tunge %>%
  mutate(AAR = ifelse(AAR == nyeste_aar, paste0(AAR, stjerne), AAR))

figur2_tunge <- nyreg_data_1_tunge_stjerne |>
  filter(!str_detect(AAR, "9")) |># Exclude rows where AAR CONTATINS "9"
  mutate(AAR = factor(AAR, levels = fct_sort),
         antal = ANTAL) %>%  # Add ANTAL column for use in the tooltip
  hchart('column', hcaes(x = AAR, y = A_NYREG , group = DRIV), borderColor = 0) |> 
  hc_plotOptions(column = list(stacking = "normal"), style = list(fontFamily = "Georgia")) |> 
  hc_colors(c(trm_colors(farver))) |> 
  hc_yAxis(title = list(text = "Pct."), max = 100) |> 
  hc_xAxis(title = list(text = NULL), categories = fct_sort,
           labels = list(rotation = -30)  # Tilt the labels by -45 degrees (you can adjust the angle)
  ) %>% 
  hc_legend(reversed = TRUE, 
            layout = "horizontal", 
            align = "center", 
            verticalAlign = "bottom",
            itemStyle = list(fontSize = "11px"),
            itemDistance = 2) %>%  # Add spacing between legend items%>%
  hc_chart(marginBottom = 180)  %>%# Reduce font size if necessary %>%  # Adding spacing between items
  hc_tooltip(shared = TRUE,
             pointFormat = "<b>{series.name}</b>: {point.percentage:.1f} pct. (<b>{point.antal:,.0f}</b> lastbiler)<br>") %>%
  trm_hc_format("<b>Figur 2.2</b> Drivmidlernes andel af nyregistreringer for tunge lastbiler",
                note = str_glue("Kilde: Bilstatistik<br>Note: Tunge lastbiler dækker over lastbiler med en vægt over 4.250 kg.<br>{stjerne_tekst}"))




# Create a HTML structure with two columns
html <- tagList(
  div(style = "display: flex; justify-content: space-between;",
      div(style = "width: 48%;", figur2_lette),
      div(style = "width: 48%;", figur2_tunge)))

# Render it in the browser
browsable(html)


lette_andel_af_bestand <- bestand_seneste_lette/(bestand_seneste_tunge+bestand_seneste_lette)*100
ellette_andel_af_elbestand <- elbestand_seneste_lette/(elbestand_seneste_tunge+elbestand_seneste_lette)*100

elandel_seneste <- elbestand_seneste/bestand_seneste*100



```

Diesel er stadig det dominernde drivmiddel i bestanden af lastbiler. Bestanden af lastbiler har generelt været svagt stigende siden 1. januar 2021, hvor den samlede bestand var `r bestand_2021`, mens  bestanden ultimo januar 2025 var `r bestand_seneste` lastbiler. 

I `r format(ISOdate(2000, nummer_sidste_md, 1), "%B")` måned voksede bestanden af ellastbiler med `r udv_elbestand_seneste_måned` lastbiler således, at der primo januar 2025 var `r elbestand_seneste` ellastbiler i Danmark svarende til `r elandel_seneste` pct. af den samlede bestand jf. figur 3.


```{r}
#Ny figur 3 opgørelse af årlig bestand

bestand_data_1 |> 
  hchart('column', hcaes(x = AAR, y = ANTAL, group = DRIV ), borderColor = 0) |> 
  hc_plotOptions(column = list(stacking = "normal")) |> 
  hc_colors(c(trm_colors(farver))) |> 
  hc_yAxis(
    title = list(text = "Antal"),
    labels = list(formatter = JS("function() {
     return this.value >= 1000 ? (this.value / 1000).toFixed(0) : this.value;
    }")),
    stackLabels = list(enabled = TRUE, verticalAlign = 'top',
                       crop = FALSE, overflow = 'none')
  ) |> 
  hc_xAxis(title = list(text = NULL),
           labels = list(rotation = -30))|>
  hc_tooltip(shared=TRUE,

             pointFormat = "<b>{series.name}</b>: {point.percentage:.1f} pct. ({point.y:,.0f} lastbiler) <br>") %>%
  trm_hc_format("<b>Figur 3</b> Udviklingen i den samlede bestand af lastbiler",
                note = str_glue("Kilde: Bilstatistik"))%>% 
  hc_legend(reversed = TRUE)

```
Omend bestanden af lette lastbiler blot udgør `r lette_andel_af_bestand` pct. af den samlede bestand af lastbiler, er det værd at bemærke, at bestanden af lette lastbiler er i vækst, og at det er særligt er lette ellastbiler, der kommer til. Ved udgangen af `r seneste_md` udgjorde ellastbiler `r elbestand_seneste_lette/bestand_seneste_lette*100` pct. af den samlede bestand af lette lastbiler, jf. figur 3.1. I modsætning hertil udgjorde ellastbiler blot `r elbestand_seneste_tunge/bestand_seneste_tunge*100` pct. af den samlede bestand af tunge lastbiler, jf. figur 3.2. Lette elastbiler udgør således `r ellette_andel_af_elbestand` pct. af den samlede bestand af ellastbiler. 

```{r}
#Figur 3.1. Udviklingen i den samlede bestand af lette lastbiler


categories <- unique(bestand_data_1_lette$AAR)

figur3_lette <- bestand_data_1_lette |> 
  hchart('column', hcaes(x = AAR, y = ANTAL, group = DRIV), borderColor = 0) |> 
  hc_plotOptions(column = list(stacking = "normal")) |> 
  hc_colors(as.character(trm_colors(farver[c(1, 2, 4)]))) |>  # Use only "blaa" and "groen" (the second and fourth colors)
  hc_yAxis(
    title = list(text = "Antal"),
    labels = list(formatter = JS("function() {
      return this.value >= 1000 ? (this.value / 1000).toFixed(0) : this.value;
    }")),
    stackLabels = list(enabled = TRUE, verticalAlign = 'top',
                       crop = FALSE, overflow = 'none')
  ) |> 
  hc_xAxis(
    categories = categories,
    title = list(text = NULL),
    labels = list(
      rotation = -30
      # ,
      # formatter = JS("
      #        function() {
      #          var categories = this.axis.categories; // Get the x-axis categories
      #          var secondToLastIndex = categories.length - 2; // Find the second-to-last index
      #          
      #          if (this.pos === secondToLastIndex) {
      #            return this.value + '*'; // Add '*' to the second-to-last category
      #          }
      #          
      #          return this.value;
      #        }
      #      ")
    ) )|>
  hc_tooltip(shared=TRUE,
             pointFormat = "<b>{series.name}</b>: {point.percentage:.1f} pct. ({point.y:,.0f} lastbiler) <br>") %>%
  trm_hc_format("<b>Figur 3.1</b> Udviklingen i den samlede bestand af lette lastbiler",
                note = str_glue("Kilde: Bilstatistik<br>Note: Lette lastibler dækker over lastbiler med en på vægt på 4.250 kg. og nedefter."))%>% 
  hc_legend(reversed = TRUE, 
            layout = "horizontal", 
            align = "center", 
            verticalAlign = "bottom",
            itemStyle = list(fontSize = "11px"),
            itemDistance = 2) %>%  # Add spacing between legend items%>%
  hc_chart(marginBottom = 180)# Reduce font size if necessary %>%  # Adding spacing between items

#Figur 3.2. Udviklingen i den samlede bestand af tunge lastbiler

figur3_tunge <-bestand_data_1_tunge |> 
  hchart('column', hcaes(x = AAR, y = ANTAL, group = DRIV ), borderColor = 0) |> 
  hc_plotOptions(column = list(stacking = "normal")) |> 
  hc_colors(c(trm_colors(farver))) |> 
  hc_yAxis(
    title = list(text = "Antal (tusind)"),
    labels = list(formatter = JS("function() {
      return this.value >= 1000 ? (this.value / 1000).toFixed(0) : this.value;
    }")),
    stackLabels = list(enabled = TRUE, verticalAlign = 'top',
                       crop = FALSE, overflow = 'none')
  ) |> 
  hc_xAxis(    categories = categories,  # Set categories explicitly
               title = list(text = NULL),
               labels = list(rotation=-30
                             # ,
                             # formatter = JS("
                             #        function() {
                             #          var categories = this.axis.categories; // Get the x-axis categories
                             #          var secondToLastIndex = categories.length - 2; // Find the second-to-last index
                             #          
                             #          if (this.pos === secondToLastIndex) {
                             #            return this.value + '*'; // Add '*' to the second-to-last category
                             #          }
                             #          
                             #          return this.value;
                             #        }
                             #      ")
               ) )|>
  hc_tooltip(shared=TRUE,
             pointFormat = "<b>{series.name}</b>: {point.percentage:.1f} pct. ({point.y:,.0f} lastbiler) <br>") %>%
  trm_hc_format("<b>Figur 3.2</b> Udviklingen i den samlede bestand af tunge lastbiler",
                note = str_glue("Kilde: Bilstatisitk<br>Note: Tunge lastbiler dækker over lastbiler med en vægt over 4.250 kg."))%>%   
  hc_legend(reversed = TRUE, 
            layout = "horizontal", 
            align = "center", 
            verticalAlign = "bottom",
            itemStyle = list(fontSize = "11px"),
            itemDistance = 2) %>%  # Add spacing between legend items%>%
  hc_chart(marginBottom = 180) 

# Create a HTML structure with two columns
html <- tagList(
  div(style = "display: flex; justify-content: space-between;",
      div(style = "width: 48%;", figur3_lette),
      div(style = "width: 48%;", figur3_tunge)
  )
)

# Render it in the browser
browsable(html)


rest <- abs(KF_tal$ANTAL[[2]] - elbestand_seneste)

```


Ifølge Klimastatus og -fremskrvining 2024 forventes der at være cirka `r KF_tal$ANTAL[[2]]` elektriske lastbiler i Danmark ved udgangen af 2025. Differencen mellem det nuværende antal  og det forventede antal elektriske lastbiler ved udgangen af 2025 er således `r rest` lastbiler, jævnfør figur 4.



```{r}
#Figur 4. Status for antallet af ellastbiler i 2025 - oberserveret versus forventet

KF_tal <- KF_tal %>%
  mutate (x_axis = str_replace(x_axis, " forventet", ""))     

bestand_data_1 %>% 
  filter(AAR == "2024" | AAR == "2025", DRIV == "El") %>% 
  mutate(x_axis = ifelse(str_detect(AAR, "\\("),
                         str_c("Ultimo ", seneste_md, " ", nyeste_aar),
                         str_c("1. januar ", AAR)),
         oprindelse = "Bilstatistik",
         ANTAL,
         .keep = "none") %>%
  bind_rows(KF_tal) |> 
  hchart('column', hcaes(x = x_axis, y = ANTAL, group = oprindelse), 
         color = trm_colors(c("blaa", "orange")), borderColor = 0) |>
  hc_yAxis(title = list(text = "Antal")) |>
  hc_xAxis(
    title = list(text = NULL),
    
    labels = list(
      align = "center",    # Align labels to center under the bars
      rotation = 0         # Keep labels horizontal (adjust if needed)
    ),
    tickmarkPlacement = "on"  # Ensures bars are centered on ticks
  ) |>
  
  hc_plotOptions(column = list(
    pointWidth = 100,       # Bar width
    groupPadding = 0.52,    # Space between groups of bars
    pointPadding = 0.1    # Space between bars in the same group
  )) %>%
  trm_hc_format("<b>Figur 4.</b> Status for antallet af ellastbiler i 2025 - oberserveret versus forventet",
                note = str_glue("Kilde: Bilstatistik"))



nyreg_data_underkat_txt_el <- nyreg_data_underkat %>% filter(AAR == nyeste_aar-1, DRIV == "El") %>% select(KASSORI, ANTAL) %>% deframe() %>% as.list()

nyreg_data_underkat_txt_samlet <- nyreg_data_underkat %>% filter(AAR == nyeste_aar-1) %>% 
  summarise(ANTAL = sum(ANTAL),
            .by = "KASSORI") %>% deframe() %>% as.list()

bestand_data_underkat_txt_el <- bestand_data_underkat %>% filter(str_detect(AAR, "2025"), DRIV == "El") %>% select(KASSORI, A_BESTAND) %>% deframe() %>% as.list()



nyeste_aars_udv <- bestand_data_udv %>% 
  filter(AAR == nyeste_aar) %>%  # Filter rows with the latest date
  pull(name =DRIV)     

sidste_aars_udv <- bestand_data_udv %>% 
  filter(AAR == nyeste_aar-1) %>%  # Filter rows with the latest date
  pull(name = DRIV)

```

Bestanden af diesellastbiler er indtil videre `r ifelse((nyeste_aars_udv[["Diesel"]]) >= 0, "steget", "faldet")`
med `r abs(nyeste_aars_udv[["Diesel"]])` i `r as.character(nyeste_aar)`, mens bestanden af ellastbiler er steget med `r nyeste_aars_udv[["El"]]`. I samme periode sidste år `r ifelse((nyeste_aars_udv[["Diesel"]]) >= 0, "steg", "faldt")`
 bestanden af diesellastbiler med `r abs(sidste_aars_udv[["Diesel"]])`, mens antallet af ellastbiler steg med `r sidste_aars_udv[["El"]]`.


```{r}
#Figur 5. Udviklingen i bestand af lastbiler fordelt på drivmidler. Januar - seneste_md

bestand_data_udv$AAR <- bestand_data_udv$AAR - 1 

bestand_data_udv |>
  arrange(AAR, desc(DRIV)) %>%
  hchart('column', hcaes(x = AAR, y = UDV, group = DRIV ), borderColor = 0) |>
  hc_colors(c(trm_colors(c(sort(farver, decreasing = T) %>% as.character(), "lyseblaa")))) |>
  # hc_legend(reversed =TRUE) %>%
  hc_yAxis(title = list(text = "Antal"),
           labels = list(
             formatter = JS("function() {
      return this.value ? (this.value).toFixed(0) : this.value;
    }"))) |>
  hc_xAxis(title = list(text = NULL)) |>
  hc_tooltip() %>% 
  trm_hc_format(str_glue("<b>Figur 5.</b> Udviklingen i bestand af lastbiler fordelt på drivmidler. Januar - {seneste_md}"),
                note = str_glue("Kilde: Bilstatistik"))

# TODO: Kommentar fra Camilla: her er noget med fortegn

```


Opdeles lastbilerne i supplerende karosseri, ses tydeligt, at det primært har været renovationslastbiler, som har omstillet til el først. Disse lastbiler er i højere grad styret af krav fra offentlige udbud og kører typisk ikke særlig langt på en dag. Sidste år udgjorde el `r nyreg_data_underkat_txt_el$RENOVATIONSAGGREGAT/nyreg_data_underkat_txt_samlet$RENOVATIONSAGGREGAT*100` pct. af det samlede nyregistreringer af renovations lastbiler, mens el udgjorde `r nyreg_data_underkat_txt_el$LUKKET_KASSE/nyreg_data_underkat_txt_samlet$LUKKET_KASSE*100` pct. af alle nyregistrerede lastbiler med lukket kasse.

Da en lastbil kan have mange forskellige supplerende karosserier, kan en lastbil optræde i flere af kategorierne.

```{r, results='asis'}
cat("**Figur 6. Andel af nyregistreringer fordelt supplerende karosseri og drivmiddel**")



nyreg_data_underkat <- nyreg_data_underkat %>% 
  filter(!str_detect(AAR, "2019"))  # Exclude rows where AAR contains "2019"

nyreg_data_underkat_stjerne <- nyreg_data_underkat %>%
  mutate(AAR = ifelse(AAR == nyeste_aar, paste0(AAR, stjerne), AAR))

fct_sort_underkat <- nyreg_data_underkat_stjerne$AAR %>% unique()


map(udvalgte_kat, ~{nyreg_data_underkat_stjerne |>
    filter(KASSORI==.x) %>% 
    mutate(AAR = factor(AAR, levels = fct_sort_underkat)) %>% 
    hchart('column', hcaes(x = AAR, y =ANTAL, group = DRIV ), borderColor = 0) |> 
    hc_plotOptions(column = list(stacking = "percent")) |> 
    hc_colors(c(trm_colors(farver))) |> 
    hc_yAxis(title = list(text = "Pct."), max = 100) |> 
    hc_xAxis(categories = fct_sort_underkat, title = list(text = NULL)) %>% 
    hc_legend(
      layout = "horizontal",         # Arrange legends horizontally
      align = "center",              # Align the legend in the center
      verticalAlign = "bottom",      # Place the legend at the bottom
      itemDistance = 1,             # Adjust space between items
      itemWidth = 80,               # Set the width for each legend item
      itemStyle = list(
        fontSize = "12",
        width = 60                  
      )              # Set the legend width to fit 2 items per row)# Reduce space between legend items# Place legends at the bottom
      # Reduce space between legend items# Place legends at the bottom
    ) %>% 
    hc_tooltip(shared = TRUE,
               pointFormat = "<b>{series.name}</b>: {point.percentage:.1f} pct. ({point.y:,.0f} lastbiler) <br>"
    )  %>% 
    trm_hc_format(
      str_glue(str_glue("<b>{str_replace_all(.x, c('_'=' ', 'OE'='Ø', 'AA'='Å', 'AE'='Æ')) %>% str_to_sentence()}<b>")),
      note = str_glue("Kilde: Bilstatistik<br>{stjerne_tekst}")
    )
}) |> 
  hw_grid(rowheight = 400) %>% htmltools::browsable()




# TODO: Der er noget tekst jeg ikke kan se
```



Bestanden af gasrenovationslastbiler toppede i 2022 og har været svagt faldende siden. I samme periode er ellastbiler gået fra at udgøre 2,1 pct. 1. januar 2022 til at udgøre `r bestand_data_underkat_txt_el$RENOVATIONSAGGREGAT` pct. i `r seneste_md` `r as.character(nyeste_aar)`.

Da en lastbil kan have mange forskellige supplerende karosserier, kan en lastbil optræde i flere af kategorierne.


**Figur 7. Bestanden fordelt supplerende karosseri og drivmiddel**
```{r}
bestand_data_underkat <- bestand_data_underkat %>%
  arrange(AAR, DRIV, KASSORI)

fct_sort_underkat <- bestand_data_underkat$AAR %>% unique()

map(udvalgte_kat, ~{
  bestand_data_underkat |> 
    filter(KASSORI == .x) |>
    mutate(AAR = factor(AAR, levels = fct_sort_underkat)) %>% 
    hchart('column', hcaes(x = AAR, y = ANTAL, group = DRIV), borderColor = 0) |> 
    hc_plotOptions(column = list(stacking = "NULL")) |> 
    hc_colors(c(trm_colors(farver))) |> 
    hc_yAxis(
      title = list(text = "Antal"),
      labels = list(format = "{value:,.0f}")
    ) |> 
    hc_xAxis(categories = fct_sort_underkat,  # Ensure all years are included
             title = list(text = NULL),
             labels = list(rotation = -60)) |> 
    hc_legend(
      layout = "horizontal",
      align = "center",
      verticalAlign = "bottom",
      itemDistance = 1,
      itemWidth = 80,
      itemStyle = list(fontSize = "12", width = 60)
    ) |> 
    hc_tooltip(shared = TRUE,
               pointFormat = "<b>{series.name}</b>: {point.y:,.0f} lastbiler ({point.percentage:.1f} pct.) <br>") |>
    trm_hc_format(
      str_glue("<b>{str_replace_all(.x, c('_'=' ', 'OE'='Ø', 'AA'='Å', 'AE'='Æ')) %>% str_to_sentence()}</b>"),
      note = "Kilde: Bilstatistik"
    )
}) |> 
  hw_grid(rowheight = 400) %>% htmltools::browsable()


```





